<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aether P2P Messenger - Advanced</title>
    <!-- PeerJS for P2P Networking -->
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* 
         * ==================================================================
         * THEME CONFIGURATION (Unchanged Base, Extended for Features)
         * ==================================================================
         */
        :root {
            /* Light Theme */
            --primary-hue: 250;
            --primary: hsl(var(--primary-hue), 80%, 60%);
            --primary-dark: hsl(var(--primary-hue), 80%, 50%);
            --primary-light: hsl(var(--primary-hue), 80%, 75%);
            --primary-fade: hsla(var(--primary-hue), 80%, 60%, 0.1);
            
            --bg-body: #f0f2f5;
            --bg-surface: #ffffff;
            --bg-surface-2: #f7f9fc;
            
            --text-main: #1a1b1e;
            --text-muted: #888888;
            --text-light: #ffffff;
            
            --border: #e1e4e8;
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.05);
            --shadow-md: 0 8px 24px rgba(0,0,0,0.08);
            --shadow-lg: 0 16px 40px rgba(0,0,0,0.12);
            
            --radius-sm: 8px;
            --radius-md: 16px;
            --radius-lg: 24px;
            --radius-full: 9999px;
            
            --safe-area-top: env(safe-area-inset-top);
            --safe-area-bottom: env(safe-area-inset-bottom);

            --anim-bounce: 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            --msg-me-bg: var(--primary);
            --msg-other-bg: var(--bg-surface);
        }

        [data-theme="dark"] {
            --bg-body: #121212;
            --bg-surface: #1e1e1e;
            --bg-surface-2: #2c2c2c;
            
            --text-main: #e0e0e0;
            --text-muted: #a0a0a0;
            
            --border: #333333;
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.3);
            --shadow-md: 0 8px 24px rgba(0,0,0,0.4);
            --msg-me-bg: var(--primary-dark);
            --msg-other-bg: #2a2a2a;
        }

        /* 
         * ==================================================================
         * BASE STYLES
         * ==================================================================
         */
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; font-family: 'Inter', sans-serif; }
        html, body { width: 100%; height: 100%; overflow: hidden; background-color: var(--bg-body); color: var(--text-main); transition: 0.3s; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--text-muted); border-radius: var(--radius-full); opacity: 0.2; }

        /* Utilities */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .justify-between { justify-content: space-between; }
        .w-full { width: 100%; }
        .h-full { height: 100%; }
        .text-center { text-align: center; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-4 { margin-bottom: 1rem; }
        .p-4 { padding: 1rem; }

        /* Components */
        .btn { border: none; outline: none; padding: 12px 24px; border-radius: var(--radius-md); font-weight: 600; font-size: 1rem; cursor: pointer; transition: 0.2s; position: relative; overflow: hidden; }
        .btn:active { transform: scale(0.96); }
        .btn-primary { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; box-shadow: 0 4px 15px var(--primary-fade); }
        .btn-secondary { background: var(--bg-surface); color: var(--text-main); border: 1px solid var(--border); }
        .btn-icon { width: 44px; height: 44px; border-radius: 50%; padding: 0; display: flex; align-items: center; justify-content: center; background: var(--bg-surface); color: var(--text-muted); box-shadow: var(--shadow-sm); cursor: pointer; border:none; transition: 0.2s; }
        .btn-icon:hover { color: var(--primary); transform: translateY(-2px); }
        .btn-icon.active { color: var(--primary); background: var(--primary-fade); }

        .input-group { position: relative; margin-bottom: 1.5rem; width: 100%; }
        .input-field { width: 100%; padding: 16px; border-radius: var(--radius-md); border: 2px solid transparent; background: var(--bg-surface); color: var(--text-main); font-size: 1rem; box-shadow: var(--shadow-sm); transition: 0.3s; }
        .input-field:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 4px var(--primary-fade); }
        .input-label { position: absolute; left: 16px; top: 16px; color: var(--text-muted); pointer-events: none; transition: 0.2s; background: transparent; }
        .input-field:focus ~ .input-label, .input-field:not(:placeholder-shown) ~ .input-label { top: -10px; left: 12px; font-size: 0.75rem; background: var(--bg-body); padding: 0 6px; color: var(--primary); font-weight: 600; }

        /* Layout */
        #app { position: relative; width: 100%; max-width: 600px; margin: 0 auto; height: 100%; background: var(--bg-surface-2); box-shadow: var(--shadow-lg); overflow: hidden; display: flex; flex-direction: column; }
        
        .app-header { height: 70px; background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; padding-top: var(--safe-area-top); position: absolute; top: 0; left: 0; right: 0; z-index: 100; border-bottom: 1px solid var(--border); }
        [data-theme="dark"] .app-header { background: rgba(30, 30, 30, 0.85); }
        .header-title { font-size: 1.25rem; font-weight: 700; color: var(--text-main); }
        .header-status { width: 10px; height: 10px; border-radius: 50%; background-color: #ff4757; box-shadow: 0 0 8px rgba(255, 71, 87, 0.5); transition: 0.3s; }
        .header-status.online { background-color: #2ed573; box-shadow: 0 0 8px rgba(46, 213, 115, 0.5); }

        .view { position: absolute; top: 0; left: 0; width: 100%; height: 100%; padding-top: 70px; padding-bottom: 0; overflow-y: auto; opacity: 0; transform: translateX(20px); pointer-events: none; transition: opacity 0.4s ease, transform 0.4s ease; display: flex; flex-direction: column; background: var(--bg-body); z-index: 10; }
        .view.active { opacity: 1; transform: translateX(0); pointer-events: all; z-index: 20; }

        /* Login View */
        #view-login { z-index: 50; padding: 40px; justify-content: center; align-items: center; background: var(--bg-body); }
        .logo-container { width: 100px; height: 100px; background: linear-gradient(135deg, var(--primary), var(--primary-light)); border-radius: 30px; display: flex; align-items: center; justify-content: center; margin-bottom: 2rem; font-size: 3rem; color: white; box-shadow: 0 10px 30px var(--primary-fade); animation: float 6s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .credits-footer { position: absolute; bottom: 30px; text-align: center; width: 100%; left: 0; font-size: 0.85rem; color: var(--text-muted); opacity: 0.8; }

        /* Home View */
        .id-card { background: var(--bg-surface); padding: 20px; border-radius: var(--radius-md); margin: 20px; box-shadow: var(--shadow-md); text-align: center; border: 1px solid var(--border); }
        .id-display { font-family: monospace; font-size: 1.5rem; color: var(--primary); margin: 10px 0; letter-spacing: 1px; word-break: break-all; }
        .connect-section { padding: 20px; background: var(--bg-surface); border-radius: var(--radius-lg) var(--radius-lg) 0 0; margin-top: auto; box-shadow: 0 -4px 20px rgba(0,0,0,0.05); }
        
        /* Saved Contacts List */
        .contacts-list { flex: 1; overflow-y: auto; padding: 0 20px; }
        .contact-item { display: flex; align-items: center; padding: 12px; background: var(--bg-surface); border-radius: var(--radius-md); margin-bottom: 10px; border: 1px solid var(--border); transition: 0.2s; cursor: pointer; }
        .contact-item:hover { transform: translateX(5px); border-color: var(--primary); }
        .contact-avatar { width: 40px; height: 40px; background: var(--primary-light); color: var(--primary-dark); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 12px; }
        .contact-info { flex: 1; }
        .contact-name { font-weight: 600; font-size: 0.95rem; }
        .contact-id { font-size: 0.75rem; color: var(--text-muted); font-family: monospace; }

        /* Chat View */
        #view-chat { display: flex; flex-direction: column; background: var(--bg-surface-2); }
        .chat-header-bar { padding: 15px; background: var(--bg-surface); border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 15px; }
        .chat-area { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; scroll-behavior: smooth; }
        
        .message-bubble { max-width: 80%; padding: 12px 16px; font-size: 0.95rem; line-height: 1.4; position: relative; word-wrap: break-word; animation: popIn 0.3s var(--anim-bounce); display: flex; flex-direction: column; }
        @keyframes popIn { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        
        .msg-system { align-self: center; background: rgba(0,0,0,0.05); color: var(--text-muted); font-size: 0.8rem; border-radius: 20px; padding: 6px 15px; max-width: 90%; text-align: center; }
        [data-theme="dark"] .msg-system { background: rgba(255,255,255,0.1); }
        
        .msg-me { align-self: flex-end; background: var(--msg-me-bg); color: white; border-radius: 18px 18px 4px 18px; box-shadow: 0 4px 10px var(--primary-fade); }
        .msg-me .msg-meta { color: rgba(255,255,255,0.8); }
        
        .msg-other { align-self: flex-start; background: var(--msg-other-bg); color: var(--text-main); border-radius: 18px 18px 18px 4px; box-shadow: var(--shadow-sm); border: 1px solid var(--border); }

        .msg-meta { font-size: 0.7rem; margin-top: 4px; text-align: right; align-self: flex-end; }
        
        /* Media Styles */
        .msg-image { max-width: 100%; border-radius: 12px; margin-bottom: 5px; cursor: pointer; }
        .msg-audio-container { display: flex; align-items: center; gap: 10px; width: 200px; padding-bottom: 5px; }
        .audio-play-btn { background: rgba(255,255,255,0.2); width: 32px; height: 32px; border-radius: 50%; border: none; color: inherit; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .msg-other .audio-play-btn { background: rgba(0,0,0,0.1); }
        .audio-wave { flex: 1; height: 24px; display: flex; align-items: center; justify-content: space-around; }
        .wave-bar { width: 3px; background: currentColor; border-radius: 2px; animation: quiet 1s infinite; }
        .playing .wave-bar { animation: loud 0.8s infinite; }
        @keyframes loud { 0%, 100% { height: 20%; } 50% { height: 100%; } }
        @keyframes quiet { 0% { height: 20%; } }

        /* Chat Input Area */
        .chat-input-area { background: var(--bg-surface); padding: 15px; padding-bottom: max(15px, var(--safe-area-bottom)); display: flex; align-items: center; gap: 10px; border-top: 1px solid var(--border); position: relative; }
        .chat-input { flex: 1; background: var(--bg-body); border: 1px solid var(--border); padding: 12px 20px; border-radius: 24px; color: var(--text-main); outline: none; transition: 0.2s; }
        .chat-input:focus { border-color: var(--primary); }
        .btn-send { width: 48px; height: 48px; border-radius: 50%; background: var(--primary); color: white; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 10px var(--primary-fade); transition: 0.2s; }
        .btn-send:hover { transform: scale(1.05); }

        /* Media Attachments Menu */
        .attachments-menu { position: absolute; bottom: 80px; left: 15px; background: var(--bg-surface); border-radius: var(--radius-md); padding: 10px; display: flex; flex-direction: column; gap: 10px; box-shadow: var(--shadow-lg); border: 1px solid var(--border); transform: scale(0); transform-origin: bottom left; transition: 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 50; }
        .attachments-menu.open { transform: scale(1); }
        .attach-opt { display: flex; align-items: center; gap: 10px; padding: 10px; border-radius: var(--radius-sm); cursor: pointer; transition: 0.2s; }
        .attach-opt:hover { background: var(--bg-body); }
        .attach-opt i { width: 24px; text-align: center; color: var(--primary); }

        /* Recording Overlay */
        .recording-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-surface); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; z-index: 20; transform: translateY(100%); transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .recording-overlay.active { transform: translateY(0); }
        .rec-indicator { display: flex; align-items: center; gap: 10px; color: #ff4757; font-weight: 600; }
        .rec-dot { width: 12px; height: 12px; background: #ff4757; border-radius: 50%; animation: pulseRed 1s infinite; }
        @keyframes pulseRed { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(1.2); } 100% { opacity: 1; transform: scale(1); } }
        
        #audio-visualizer { width: 100px; height: 40px; }

        /* Settings Modal & Toast */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 200; opacity: 0; pointer-events: none; transition: 0.3s; display: flex; justify-content: center; align-items: center; }
        .modal-overlay.open { opacity: 1; pointer-events: all; }
        .modal-card { width: 85%; max-width: 400px; background: var(--bg-surface); border-radius: var(--radius-lg); padding: 24px; transform: translateY(50px); transition: 0.3s var(--anim-bounce); box-shadow: var(--shadow-lg); }
        .modal-overlay.open .modal-card { transform: translateY(0); }
        .setting-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border); }
        
        /* Switch */
        .switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(24px); }

        #toast-container { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 500; display: flex; flex-direction: column; gap: 10px; width: 90%; max-width: 350px; pointer-events: none; }
        .toast { background: rgba(30,30,30,0.9); color: white; padding: 14px 20px; border-radius: var(--radius-md); font-size: 0.9rem; box-shadow: var(--shadow-lg); animation: slideUp 0.3s ease forwards; backdrop-filter: blur(4px); display: flex; align-items: center; gap: 10px; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* Typing Indicator */
        .typing-indicator { padding: 10px; display: none; }
        .typing-indicator.active { display: block; }
        .dots { display: flex; gap: 4px; }
        .dot { width: 6px; height: 6px; background: var(--text-muted); border-radius: 50%; animation: pulse 1s infinite; }
        .dot:nth-child(2) { animation-delay: 0.2s; }
        .dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes pulse { 0%, 100% { opacity: 0.4; transform: scale(0.8); } 50% { opacity: 1; transform: scale(1.2); } }

    </style>
</head>
<body>

<div id="app">
    <!-- Header (Shared) -->
    <header class="app-header">
        <div class="header-status" id="connection-status"></div>
        <div class="header-title">Aether v2</div>
        <button class="btn-icon" id="btn-settings">
            <i class="fas fa-cog"></i>
        </button>
    </header>

    <!-- VIEW 1: LOGIN -->
    <section id="view-login" class="view active">
        <div class="logo-container"><i class="fas fa-bolt"></i></div>
        <h2 class="text-center mb-4">Welcome Back</h2>
        <p class="text-center mb-4" style="color:var(--text-muted)">Advanced P2P Messaging</p>
        <div class="input-group">
            <input type="text" id="input-username" class="input-field" placeholder=" " autocomplete="off">
            <label class="input-label">Choose a Username</label>
        </div>
        <button id="btn-login" class="btn btn-primary w-full">Start Messaging</button>
        <div class="credits-footer">Created by <strong>Yaroslav Ostapenko</strong></div>
    </section>

    <!-- VIEW 2: HOME (CONTACTS) -->
    <section id="view-home" class="view">
        <div class="p-4 flex-col h-full">
            <h3 class="mb-2">My Connection ID</h3>
            <div class="id-card">
                <div class="id-display" id="my-peer-id">Initializing...</div>
                <div class="flex justify-center gap-2">
                    <button class="btn btn-secondary btn-sm" id="btn-copy-id"><i class="fas fa-copy"></i> Copy</button>
                    <button class="btn btn-secondary btn-sm" id="btn-share-id"><i class="fas fa-share-alt"></i> Share</button>
                </div>
            </div>

            <h3 class="mb-2">Saved Contacts</h3>
            <div class="contacts-list" id="contacts-list-container">
                <!-- Dynamically populated -->
                <div class="text-center p-4" style="color:var(--text-muted); font-size:0.9rem; margin-top:20px;">
                    No saved contacts yet.
                </div>
            </div>

            <div class="connect-section">
                <h3 class="mb-4">Connect New</h3>
                <div class="input-group">
                    <input type="text" id="input-remote-id" class="input-field" placeholder=" ">
                    <label class="input-label">Paste Friend's ID</label>
                </div>
                <button id="btn-connect" class="btn btn-primary w-full">Connect <i class="fas fa-arrow-right"></i></button>
            </div>
        </div>
    </section>

    <!-- VIEW 3: CHAT -->
    <section id="view-chat" class="view">
        <div class="chat-header-bar">
            <div class="btn-icon" id="btn-back-chat"><i class="fas fa-arrow-left"></i></div>
            <div style="flex:1">
                <h4 id="chat-partner-name">Unknown</h4>
                <div class="flex items-center gap-1">
                    <span style="font-size:0.75rem; color:var(--text-muted)">Encrypted</span>
                    <i class="fas fa-lock" style="font-size:0.6rem; color:var(--primary)"></i>
                </div>
            </div>
            <button class="btn-icon" id="btn-save-contact" title="Save Contact"><i class="fas fa-user-plus"></i></button>
        </div>

        <div id="messages-container" class="chat-area"></div>

        <div class="typing-indicator" id="typing-indicator">
            <div class="dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
        </div>

        <div class="chat-input-area">
            <!-- Hidden inputs for files -->
            <input type="file" id="file-input-image" accept="image/*" class="hidden">
            
            <!-- Attachments Menu -->
            <div class="attachments-menu" id="attachments-menu">
                <div class="attach-opt" id="opt-image">
                    <i class="fas fa-image"></i> <span>Photo</span>
                </div>
                <div class="attach-opt" id="opt-audio">
                    <i class="fas fa-microphone"></i> <span>Voice Note</span>
                </div>
            </div>

            <button class="btn-icon" id="btn-toggle-attach"><i class="fas fa-paperclip"></i></button>
            <input type="text" id="msg-input" class="chat-input" placeholder="Type a message..." autocomplete="off">
            <button id="btn-send-msg" class="btn-send"><i class="fas fa-paper-plane"></i></button>

            <!-- Recording Overlay -->
            <div class="recording-overlay" id="recording-overlay">
                <div class="rec-indicator">
                    <div class="rec-dot"></div>
                    <span id="rec-timer">00:00</span>
                </div>
                <canvas id="audio-visualizer"></canvas>
                <div class="flex gap-2">
                    <button class="btn-icon" id="btn-cancel-rec" style="color:#ff4757"><i class="fas fa-trash"></i></button>
                    <button class="btn-icon active" id="btn-stop-send-rec"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
    </section>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settings-modal">
        <div class="modal-card">
            <div class="flex justify-between items-center mb-4">
                <div class="modal-title" style="margin:0">Settings</div>
                <button class="btn-icon" id="btn-close-settings"><i class="fas fa-times"></i></button>
            </div>
            <div class="setting-row">
                <span>Dark Mode</span>
                <label class="switch"><input type="checkbox" id="theme-toggle"><span class="slider"></span></label>
            </div>
            <div class="setting-row">
                <span>Sound Effects</span>
                <label class="switch"><input type="checkbox" checked id="sound-toggle"><span class="slider"></span></label>
            </div>
            <div class="p-4" style="margin-top:20px; background:var(--bg-body); border-radius:var(--radius-sm); text-align:center;">
                <small style="color:var(--text-muted)">
                    Aether Messenger v2.0<br>
                    Created by <strong>Yaroslav Ostapenko</strong><br>
                    Secure P2P WebRTC
                </small>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>
</div>

<script>
/**
 * ======================================================================
 * ARCHITECTURE OVERVIEW
 * ======================================================================
 * The application is divided into Service Classes to separate concerns:
 * 1. EventBus: Handles publish/subscribe events across the app.
 * 2. Store: Manages global state (User, Theme, Settings).
 * 3. StorageService: Handles localStorage (Chat history, Contacts).
 * 4. AudioService: Handles MediaRecorder and Canvas Visualization.
 * 5. ImageService: Handles file reading and compression.
 * 6. NetworkService: Wrapper around PeerJS.
 * 7. UIManager: Manipulates the DOM.
 * 8. Main: Bootstraps the application.
 */

// --- 1. Event Bus ---
class EventBus {
    constructor() { this.events = {}; }
    on(event, callback) {
        if (!this.events[event]) this.events[event] = [];
        this.events[event].push(callback);
    }
    emit(event, data) {
        if (this.events[event]) this.events[event].forEach(cb => cb(data));
    }
}
const Bus = new EventBus();

// --- 2. Store ---
const Store = {
    state: {
        username: localStorage.getItem('aether_username') || '',
        theme: localStorage.getItem('aether_theme') || 'light',
        soundEnabled: true,
        currentView: 'view-login',
        myId: null,
        connectedPeerId: null,
        connectedPeerName: null
    },
    update(key, value) {
        this.state[key] = value;
        if(key === 'theme') localStorage.setItem('aether_theme', value);
        if(key === 'username') localStorage.setItem('aether_username', value);
    },
    get(key) { return this.state[key]; }
};

// --- 3. Storage Service ---
class StorageService {
    constructor() {
        this.CONTACTS_KEY = 'aether_contacts';
        this.CHATS_KEY = 'aether_chats';
    }

    getContacts() {
        return JSON.parse(localStorage.getItem(this.CONTACTS_KEY) || '[]');
    }

    saveContact(id, name) {
        const contacts = this.getContacts();
        if (!contacts.find(c => c.id === id)) {
            contacts.push({ id, name, addedAt: Date.now() });
            localStorage.setItem(this.CONTACTS_KEY, JSON.stringify(contacts));
            Bus.emit('contacts:updated');
            return true;
        }
        return false;
    }

    getChatHistory(peerId) {
        const allChats = JSON.parse(localStorage.getItem(this.CHATS_KEY) || '{}');
        return allChats[peerId] || [];
    }

    saveMessage(peerId, messageObj) {
        const allChats = JSON.parse(localStorage.getItem(this.CHATS_KEY) || '{}');
        if (!allChats[peerId]) allChats[peerId] = [];
        allChats[peerId].push(messageObj);
        // Limit history to last 50 messages per peer to save space
        if(allChats[peerId].length > 50) allChats[peerId].shift();
        localStorage.setItem(this.CHATS_KEY, JSON.stringify(allChats));
    }
}
const DB = new StorageService();

// --- 4. Audio Service (Recording & Visualizing) ---
class AudioService {
    constructor() {
        this.mediaRecorder = null;
        this.audioChunks = [];
        this.isRecording = false;
        this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        this.analyser = this.audioCtx.createAnalyser();
        this.canvas = document.getElementById('audio-visualizer');
        this.canvasCtx = this.canvas.getContext('2d');
        this.stream = null;
        this.visualizerFrame = null;
        this.startTime = 0;
        this.timerInterval = null;
    }

    async startRecording() {
        try {
            this.stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            this.mediaRecorder = new MediaRecorder(this.stream);
            this.audioChunks = [];
            
            // Connect stream to analyser
            const source = this.audioCtx.createMediaStreamSource(this.stream);
            source.connect(this.analyser);
            this.analyser.fftSize = 256;

            this.mediaRecorder.ondataavailable = (e) => this.audioChunks.push(e.data);
            this.mediaRecorder.start();
            this.isRecording = true;
            this.startTime = Date.now();
            
            this.startVisualizer();
            this.startTimer();
            Bus.emit('audio:start');
        } catch (err) {
            console.error(err);
            Bus.emit('toast', { msg: 'Microphone access denied', type: 'error' });
        }
    }

    stopRecording() {
        return new Promise((resolve) => {
            if (!this.mediaRecorder || this.mediaRecorder.state === 'inactive') return resolve(null);
            
            this.mediaRecorder.onstop = () => {
                const audioBlob = new Blob(this.audioChunks, { type: 'audio/webm' });
                this.cleanup();
                resolve(audioBlob);
            };
            this.mediaRecorder.stop();
        });
    }

    cancelRecording() {
        if (this.mediaRecorder && this.mediaRecorder.state !== 'inactive') {
            this.mediaRecorder.stop();
        }
        this.cleanup();
        Bus.emit('audio:cancel');
    }

    cleanup() {
        this.isRecording = false;
        if (this.stream) this.stream.getTracks().forEach(track => track.stop());
        cancelAnimationFrame(this.visualizerFrame);
        clearInterval(this.timerInterval);
        this.canvasCtx.clearRect(0, 0, this.canvas.width, this.canvas.height);
    }

    startVisualizer() {
        const bufferLength = this.analyser.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);
        
        const draw = () => {
            if(!this.isRecording) return;
            this.visualizerFrame = requestAnimationFrame(draw);
            this.analyser.getByteFrequencyData(dataArray);
            
            this.canvasCtx.fillStyle = '#ffffff'; // Bg clear
            this.canvasCtx.clearRect(0, 0, this.canvas.width, this.canvas.height);
            
            const barWidth = (this.canvas.width / bufferLength) * 2.5;
            let barHeight;
            let x = 0;

            for(let i = 0; i < bufferLength; i++) {
                barHeight = dataArray[i] / 2;
                this.canvasCtx.fillStyle = `hsl(250, 80%, 60%)`; // Primary color
                this.canvasCtx.fillRect(x, this.canvas.height - barHeight, barWidth, barHeight);
                x += barWidth + 1;
            }
        };
        draw();
    }

    startTimer() {
        const timerEl = document.getElementById('rec-timer');
        this.timerInterval = setInterval(() => {
            const diff = Math.floor((Date.now() - this.startTime) / 1000);
            const m = Math.floor(diff / 60).toString().padStart(2, '0');
            const s = (diff % 60).toString().padStart(2, '0');
            timerEl.innerText = `${m}:${s}`;
        }, 1000);
    }

    // Sound generation for UI feedback
    beep(type) {
        if (!Store.get('soundEnabled')) return;
        if (this.audioCtx.state === 'suspended') this.audioCtx.resume();
        
        const osc = this.audioCtx.createOscillator();
        const gain = this.audioCtx.createGain();
        osc.connect(gain);
        gain.connect(this.audioCtx.destination);

        const now = this.audioCtx.currentTime;
        if (type === 'send') {
            osc.frequency.setValueAtTime(400, now);
            osc.frequency.exponentialRampToValueAtTime(800, now + 0.1);
            gain.gain.setValueAtTime(0.1, now);
            gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
            osc.start(now);
            osc.stop(now + 0.1);
        } else if (type === 'receive') {
            osc.frequency.setValueAtTime(800, now);
            gain.gain.setValueAtTime(0.1, now);
            gain.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
            osc.start(now);
            osc.stop(now + 0.2);
        }
    }
}
const AudioMgr = new AudioService();

// --- 5. Image Service (Compression) ---
class ImageService {
    compress(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (event) => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 800; // Limit size for P2P
                    const scaleSize = MAX_WIDTH / img.width;
                    canvas.width = MAX_WIDTH;
                    canvas.height = img.height * scaleSize;
                    
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    
                    // Compress to JPEG 0.7 quality
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                    resolve(dataUrl);
                };
                img.onerror = (err) => reject(err);
            };
            reader.onerror = (err) => reject(err);
        });
    }
}
const ImgMgr = new ImageService();

// --- 6. Network Service (PeerJS) ---
class NetworkService {
    constructor() {
        this.peer = null;
        this.conn = null;
    }

    init() {
        this.peer = new Peer(null, { debug: 1 });
        
        this.peer.on('open', (id) => {
            Store.update('myId', id);
            Bus.emit('network:ready', id);
            Bus.emit('toast', { msg: 'Online & Ready', type: 'success' });
        });

        this.peer.on('connection', (conn) => {
            this.handleConnection(conn);
            Bus.emit('toast', { msg: 'Incoming Connection...', type: 'info' });
        });

        this.peer.on('error', (err) => {
            console.error('Peer Error:', err);
            Bus.emit('toast', { msg: 'Network Error: ' + err.type, type: 'error' });
        });

        this.peer.on('disconnected', () => {
            Bus.emit('toast', { msg: 'Disconnected from server', type: 'warning' });
            this.peer.reconnect();
        });
    }

    connect(remoteId) {
        if (!this.peer) return;
        const conn = this.peer.connect(remoteId, {
            metadata: { username: Store.get('username') }
        });
        this.handleConnection(conn);
    }

    handleConnection(conn) {
        if (this.conn) this.conn.close();
        this.conn = conn;

        this.conn.on('open', () => {
            // Handshake
            this.conn.send({ type: 'handshake', username: Store.get('username') });
            Store.update('connectedPeerId', this.conn.peer);
            Bus.emit('network:connected', { id: this.conn.peer });
        });

        this.conn.on('data', (data) => {
            Bus.emit('network:data', data);
        });

        this.conn.on('close', () => {
            Bus.emit('network:disconnected');
            Store.update('connectedPeerId', null);
            this.conn = null;
        });
    }

    send(data) {
        if (this.conn && this.conn.open) {
            this.conn.send(data);
            return true;
        }
        return false;
    }
}
const Net = new NetworkService();

// --- 7. UI Manager ---
class UIManager {
    constructor() {
        this.dom = {
            views: {
                login: document.getElementById('view-login'),
                home: document.getElementById('view-home'),
                chat: document.getElementById('view-chat')
            },
            inputs: {
                username: document.getElementById('input-username'),
                remoteId: document.getElementById('input-remote-id'),
                msg: document.getElementById('msg-input'),
                file: document.getElementById('file-input-image')
            },
            btns: {
                login: document.getElementById('btn-login'),
                connect: document.getElementById('btn-connect'),
                send: document.getElementById('btn-send-msg'),
                copy: document.getElementById('btn-copy-id'),
                attach: document.getElementById('btn-toggle-attach'),
                saveContact: document.getElementById('btn-save-contact'),
                back: document.getElementById('btn-back-chat')
            },
            menus: {
                attach: document.getElementById('attachments-menu')
            },
            overlays: {
                rec: document.getElementById('recording-overlay'),
                settings: document.getElementById('settings-modal')
            },
            lists: {
                messages: document.getElementById('messages-container'),
                contacts: document.getElementById('contacts-list-container')
            }
        };

        this.bindEvents();
        this.renderContacts();
    }

    bindEvents() {
        // Navigation
        this.dom.btns.login.addEventListener('click', () => {
            const user = this.dom.inputs.username.value.trim();
            if(user.length < 3) return Bus.emit('toast', {msg:'Name too short', type:'error'});
            Store.update('username', user);
            Net.init();
            this.switchView('view-home');
        });

        this.dom.btns.back.addEventListener('click', () => this.switchView('view-home'));

        // Settings
        document.getElementById('btn-settings').addEventListener('click', () => this.dom.overlays.settings.classList.add('open'));
        document.getElementById('btn-close-settings').addEventListener('click', () => this.dom.overlays.settings.classList.remove('open'));
        document.getElementById('theme-toggle').addEventListener('change', (e) => this.toggleTheme(e.target.checked));
        document.getElementById('sound-toggle').addEventListener('change', (e) => Store.update('soundEnabled', e.target.checked));

        // Connect & Copy
        this.dom.btns.copy.addEventListener('click', () => {
            if(Store.get('myId')) {
                navigator.clipboard.writeText(Store.get('myId'));
                Bus.emit('toast', {msg:'ID Copied', type:'success'});
            }
        });

        this.dom.btns.connect.addEventListener('click', () => {
            const id = this.dom.inputs.remoteId.value.trim();
            if(id && id !== Store.get('myId')) Net.connect(id);
        });

        // Messaging
        this.dom.btns.send.addEventListener('click', () => this.sendTextMessage());
        this.dom.inputs.msg.addEventListener('keypress', (e) => { if(e.key==='Enter') this.sendTextMessage(); });
        this.dom.inputs.msg.addEventListener('input', () => {
            if(Net.conn) Net.send({ type: 'typing' });
        });

        // Attachments
        this.dom.btns.attach.addEventListener('click', () => {
            this.dom.menus.attach.classList.toggle('open');
        });

        // Image Handling
        document.getElementById('opt-image').addEventListener('click', () => {
            this.dom.menus.attach.classList.remove('open');
            this.dom.inputs.file.click();
        });
        this.dom.inputs.file.addEventListener('change', async (e) => {
            if(e.target.files.length > 0) {
                try {
                    Bus.emit('toast', {msg:'Compressing image...', type:'info'});
                    const base64 = await ImgMgr.compress(e.target.files[0]);
                    this.sendMediaMessage('image', base64);
                } catch(err) {
                    Bus.emit('toast', {msg:'Image Error', type:'error'});
                }
            }
        });

        // Audio Handling
        document.getElementById('opt-audio').addEventListener('click', () => {
            this.dom.menus.attach.classList.remove('open');
            this.dom.overlays.rec.classList.add('active');
            AudioMgr.startRecording();
        });

        document.getElementById('btn-cancel-rec').addEventListener('click', () => {
            AudioMgr.cancelRecording();
            this.dom.overlays.rec.classList.remove('active');
        });

        document.getElementById('btn-stop-send-rec').addEventListener('click', async () => {
            const blob = await AudioMgr.stopRecording();
            this.dom.overlays.rec.classList.remove('active');
            if(blob) {
                // Convert Blob to Base64 for PeerJS compatibility in single file setup
                const reader = new FileReader();
                reader.readAsDataURL(blob);
                reader.onloadend = () => {
                    this.sendMediaMessage('audio', reader.result);
                };
            }
        });

        // Save Contact
        this.dom.btns.saveContact.addEventListener('click', () => {
            const id = Store.get('connectedPeerId');
            const name = Store.get('connectedPeerName');
            if(id && name) {
                if(DB.saveContact(id, name)) {
                    Bus.emit('toast', {msg: 'Contact Saved', type:'success'});
                } else {
                    Bus.emit('toast', {msg: 'Already Saved', type:'info'});
                }
            }
        });

        // Global Events
        Bus.on('network:ready', (id) => document.getElementById('my-peer-id').innerText = id);
        
        Bus.on('network:connected', (data) => {
            this.switchView('view-chat');
            this.addSystemMessage('Connection established.');
            // Load history
            const history = DB.getChatHistory(data.id);
            this.dom.lists.messages.innerHTML = '';
            history.forEach(msg => this.renderMessage(msg));
        });

        Bus.on('network:data', (data) => this.handleIncomingData(data));
        Bus.on('network:disconnected', () => {
            document.getElementById('chat-partner-name').innerText = 'Offline';
            this.addSystemMessage('Peer disconnected.');
        });
        
        Bus.on('toast', (data) => this.showToast(data.msg, data.type));
        Bus.on('contacts:updated', () => this.renderContacts());
    }

    switchView(viewId) {
        Object.values(this.dom.views).forEach(el => el.classList.remove('active'));
        this.dom.views[viewId.replace('view-', '')].classList.add('active');
        Store.update('currentView', viewId);
    }

    toggleTheme(isDark) {
        document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
        Store.update('theme', isDark ? 'dark' : 'light');
    }

    // Message Handling
    sendTextMessage() {
        const text = this.dom.inputs.msg.value.trim();
        if(!text) return;
        
        const msgObj = {
            id: Date.now().toString(36),
            type: 'text',
            content: text,
            sender: 'me',
            timestamp: Date.now()
        };

        if(Net.send(msgObj)) {
            this.renderMessage(msgObj);
            DB.saveMessage(Store.get('connectedPeerId'), msgObj);
            this.dom.inputs.msg.value = '';
            AudioMgr.beep('send');
        } else {
            Bus.emit('toast', {msg:'Not connected', type:'error'});
        }
    }

    sendMediaMessage(type, content) {
        const msgObj = {
            id: Date.now().toString(36),
            type: type,
            content: content,
            sender: 'me',
            timestamp: Date.now()
        };
        
        if(Net.send(msgObj)) {
            this.renderMessage(msgObj);
            DB.saveMessage(Store.get('connectedPeerId'), msgObj);
            AudioMgr.beep('send');
        }
    }

    handleIncomingData(data) {
        if(data.type === 'handshake') {
            Store.update('connectedPeerName', data.username);
            document.getElementById('chat-partner-name').innerText = data.username;
            this.addSystemMessage(`${data.username} joined.`);
        } else if (data.type === 'typing') {
            this.showTypingIndicator();
        } else if (['text', 'image', 'audio'].includes(data.type)) {
            const msgObj = { ...data, sender: 'other' };
            this.renderMessage(msgObj);
            DB.saveMessage(Store.get('connectedPeerId'), msgObj);
            AudioMgr.beep('receive');
        }
    }

    // Rendering
    renderMessage(msg) {
        const div = document.createElement('div');
        const isMe = msg.sender === 'me';
        div.className = `message-bubble ${isMe ? 'msg-me' : 'msg-other'}`;
        
        const time = new Date(msg.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});

        let contentHtml = '';
        if(msg.type === 'text') {
            contentHtml = msg.content.replace(/</g, "&lt;"); // Simple sanitize
        } else if (msg.type === 'image') {
            contentHtml = `<img src="${msg.content}" class="msg-image" onclick="window.open(this.src)">`;
        } else if (msg.type === 'audio') {
            const audioId = 'audio-' + msg.id;
            contentHtml = `
                <div class="msg-audio-container">
                    <button class="audio-play-btn" onclick="document.getElementById('${audioId}').play()">
                        <i class="fas fa-play"></i>
                    </button>
                    <div class="audio-wave">
                        <div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div>
                        <div class="wave-bar"></div><div class="wave-bar"></div>
                    </div>
                    <audio id="${audioId}" src="${msg.content}" style="display:none" onplay="this.parentElement.classList.add('playing')" onended="this.parentElement.classList.remove('playing')"></audio>
                </div>
            `;
        }

        div.innerHTML = `${contentHtml}<span class="msg-meta">${time}</span>`;
        this.dom.lists.messages.appendChild(div);
        this.dom.lists.messages.scrollTop = this.dom.lists.messages.scrollHeight;
    }

    addSystemMessage(text) {
        const div = document.createElement('div');
        div.className = 'msg-system';
        div.innerText = text;
        this.dom.lists.messages.appendChild(div);
    }

    renderContacts() {
        const list = this.dom.lists.contacts;
        list.innerHTML = '';
        const contacts = DB.getContacts();

        if(contacts.length === 0) {
            list.innerHTML = `<div class="text-center p-4" style="color:var(--text-muted)">No saved contacts yet.</div>`;
            return;
        }

        contacts.forEach(c => {
            const el = document.createElement('div');
            el.className = 'contact-item';
            el.innerHTML = `
                <div class="contact-avatar">${c.name.charAt(0).toUpperCase()}</div>
                <div class="contact-info">
                    <div class="contact-name">${c.name}</div>
                    <div class="contact-id">ID: ...${c.id.substr(-8)}</div>
                </div>
                <i class="fas fa-plug" style="color:var(--text-muted)"></i>
            `;
            el.addEventListener('click', () => {
                Bus.emit('toast', {msg: `Connecting to ${c.name}...`, type:'info'});
                Net.connect(c.id);
            });
            list.appendChild(el);
        });
    }

    showTypingIndicator() {
        const el = document.getElementById('typing-indicator');
        el.classList.add('active');
        this.dom.lists.messages.scrollTop = this.dom.lists.messages.scrollHeight;
        if(this.typingTimeout) clearTimeout(this.typingTimeout);
        this.typingTimeout = setTimeout(() => el.classList.remove('active'), 2000);
    }

    showToast(msg, type) {
        const container = document.getElementById('toast-container');
        const el = document.createElement('div');
        el.className = 'toast';
        let icon = 'info-circle';
        if(type === 'success') icon = 'check-circle';
        if(type === 'error') icon = 'exclamation-triangle';
        
        el.innerHTML = `<i class="fas fa-${icon}"></i> <span>${msg}</span>`;
        container.appendChild(el);
        
        setTimeout(() => {
            el.style.opacity = '0';
            setTimeout(() => el.remove(), 300);
        }, 3000);
    }
}

// --- 8. Initialization ---
window.addEventListener('DOMContentLoaded', () => {
    // Init State
    const savedTheme = Store.get('theme');
    document.documentElement.setAttribute('data-theme', savedTheme);
    document.getElementById('theme-toggle').checked = (savedTheme === 'dark');

    const savedUser = Store.get('username');
    if(savedUser) document.getElementById('input-username').value = savedUser;

    // Start App
    const UI = new UIManager();
});

// PWA Install Prompt Handler (Optional)
window.addEventListener('beforeinstallprompt', (e) => e.preventDefault());

</script>
</body>
</html>