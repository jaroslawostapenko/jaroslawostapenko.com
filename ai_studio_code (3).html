<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CCVV Coin Miner</title>
    <!-- Crypto Library for Hashing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <!-- MQTT Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    
    <!-- Firebase Libraries (Compat Version for browser usage) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <style>
        body { background: #111; color: #0f0; font-family: 'Courier New', monospace; text-align: center; margin: 0; padding: 20px; }
        .box { border: 1px solid #0f0; padding: 20px; max-width: 500px; margin: 0 auto; box-shadow: 0 0 15px #0f0; }
        input { background: #222; border: 1px solid #0f0; color: #fff; padding: 10px; margin: 5px; width: 80%; }
        button { background: #0f0; color: #000; border: none; padding: 10px 20px; font-weight: bold; cursor: pointer; margin-top: 10px; width: 85%; }
        button:hover { background: #fff; }
        #log { height: 200px; overflow-y: scroll; border: 1px dashed #333; margin-top: 20px; text-align: left; padding: 10px; font-size: 11px; background: #000; }
        .hidden { display: none; }
        .stat { font-size: 1.2em; margin: 10px 0; }
    </style>
</head>
<body>

<div class="box">
    <h1>CCVV COIN</h1>

    <!-- LOGIN SCREEN -->
    <div id="auth-ui">
        <h3>Login / Register</h3>
        <input type="email" id="email" placeholder="Email"><br>
        <input type="password" id="pass" placeholder="Password"><br>
        <button onclick="handleLogin()">ENTER NETWORK</button>
        <p style="font-size:0.8em; color:#666;">If account doesn't exist, it will be created automatically.</p>
    </div>

    <!-- MINING DASHBOARD -->
    <div id="miner-ui" class="hidden">
        <h3>User: <span id="user-display">...</span></h3>
        <div class="stat">Balance: <span id="balance">Loading...</span> CCVV</div>
        
        <hr style="border-color:#333">
        
        <p>Current Block Challenge:</p>
        <div id="challenge" style="color:#fff; word-break: break-all;">Loading System...</div>
        
        <p>Target Difficulty: starts with <b id="difficulty" style="color:red">...</b></p>
        
        <button id="mine-btn" onclick="toggleMining()">START MINING</button>
        
        <div id="log">Logs will appear here...</div>
    </div>
</div>

<script>
    // --- 1. CONFIGURATION ---
    const firebaseConfig = {
      apiKey: "AIzaSyBcNyU7MPQxVtG4RJi-1agoid0c2ATBUv4",
      authDomain: "ccvv-1bbde.firebaseapp.com",
      databaseURL: "https://ccvv-1bbde-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "ccvv-1bbde",
      storageBucket: "ccvv-1bbde.firebasestorage.app",
      messagingSenderId: "431297055924",
      appId: "1:431297055924:web:d5cc4429d5ffe9832c5be1",
      measurementId: "G-SN29EQ1DGF"
    };

    // Initialize Firebase
    try {
        firebase.initializeApp(firebaseConfig);
        console.log("Firebase Initialized");
    } catch (e) {
        console.error(e);
        alert("Error initializing Firebase. Check console for details.");
    }
    
    const db = firebase.database();
    const auth = firebase.auth();

    // MQTT Config (Public Broker for Chat/Updates)
    const mqttClient = new Paho.MQTT.Client("broker.hivemq.com", 8000, "ccvv-" + Math.random().toString(16).substr(2, 8));
    const mqttTopic = "ccvv-coin/updates"; 

    // Global State
    let currentUser = null;
    let isMining = false;
    let nonce = 0;
    let sysData = { current_challenge: '', difficulty: '00', reward: 50 };

    // --- 2. AUTHENTICATION ---
    function handleLogin() {
        const e = document.getElementById('email').value;
        const p = document.getElementById('pass').value;
        
        if(!e || !p) return alert("Please enter email and password");

        auth.signInWithEmailAndPassword(e, p)
            .catch((error) => {
                if(error.code === 'auth/user-not-found') {
                    return auth.createUserWithEmailAndPassword(e, p);
                }
                throw error;
            })
            .then((cred) => {
                currentUser = cred.user;
                document.getElementById('auth-ui').classList.add('hidden');
                document.getElementById('miner-ui').classList.remove('hidden');
                document.getElementById('user-display').innerText = currentUser.email;
                startApp();
            })
            .catch(err => alert("Login Failed: " + err.message));
    }

    // --- 3. APP LOGIC ---
    function startApp() {
        // A. Connect MQTT
        mqttClient.connect({ onSuccess: () => {
            log("Connected to Network (MQTT)");
            mqttClient.subscribe(mqttTopic);
        }});
        mqttClient.onMessageArrived = (msg) => {
            if(!msg.payloadString.includes(currentUser.email)) {
                log(`[NET] ${msg.payloadString}`);
            }
        };

        // B. Listen to Balance
        db.ref(`users/${currentUser.uid}/balance`).on('value', snap => {
            document.getElementById('balance').innerText = snap.val() || 0;
        });

        // C. Listen to System Data (The Puzzle)
        db.ref('system').on('value', snap => {
            const val = snap.val();
            if(!val) {
                log("WAITING: Database 'system' node is empty. Please create it in Firebase Console.");
                return;
            }
            sysData = val;
            document.getElementById('challenge').innerText = sysData.current_challenge;
            document.getElementById('difficulty').innerText = sysData.difficulty;
            
            // If the challenge changed, reset our mining attempt
            nonce = 0;
            log(`New Block Available! Challenge: ${sysData.current_challenge.substring(0,8)}...`);
        });
    }

    // --- 4. MINING PROCESS ---
    function toggleMining() {
        isMining = !isMining;
        const btn = document.getElementById('mine-btn');
        btn.innerText = isMining ? "STOP MINING" : "START MINING";
        btn.style.background = isMining ? "red" : "#0f0";
        btn.style.color = isMining ? "white" : "black";
        
        if(isMining) mineLoop();
    }

    async function mineLoop() {
        if(!isMining) return;

        // 1. Create the string: Challenge + Nonce
        const str = sysData.current_challenge + nonce;
        
        // 2. Hash it
        const hash = CryptoJS.SHA256(str).toString();

        // 3. Show progress sometimes
        if(nonce % 100 === 0) {
            log(`Testing: ${nonce} | Hash: ${hash.substring(0,10)}...`);
        }

        // 4. Check Difficulty
        if(hash.startsWith(sysData.difficulty)) {
            // FOUND IT!
            isMining = false; 
            log(`>>> WINNER! Nonce: ${nonce}`);
            log(`>>> Hash: ${hash}`);
            document.getElementById('mine-btn').innerText = "CLAIMING REWARD...";
            await claimReward(nonce, hash);
        } else {
            nonce++;
            setTimeout(mineLoop, 0); 
        }
    }

    // --- 5. CLAIMING REWARD ---
    async function claimReward(winningNonce, hash) {
        const sysRef = db.ref('system');
        
        // Transaction: Ensure atomic updates (only one person wins)
        sysRef.transaction((currentSys) => {
            if(currentSys && currentSys.current_challenge === sysData.current_challenge) {
                // We are the first! Update challenge to a new random string
                return {
                    ...currentSys,
                    current_challenge: CryptoJS.lib.WordArray.random(16).toString(),
                    last_miner: currentUser.email
                };
            }
            return; // Abort if someone beat us
        }, (error, committed, snapshot) => {
            if(committed) {
                // If we successfully updated the system, give ourselves money
                const userRef = db.ref(`users/${currentUser.uid}/balance`);
                userRef.transaction(bal => (bal || 0) + sysData.reward);
                
                log(`Reward Claimed! +${sysData.reward} CCVV`);
                document.getElementById('mine-btn').innerText = "START MINING";
                document.getElementById('mine-btn').style.background = "#0f0";
                document.getElementById('mine-btn').style.color = "#000";
                
                // Broadcast to MQTT
                try {
                    const message = new Paho.MQTT.Message(`${currentUser.email} mined a block!`);
                    message.destinationName = mqttTopic;
                    mqttClient.send(message);
                } catch(e) { console.log("MQTT Error", e); }
            } else {
                log("Too late! Someone else mined it.");
                isMining = true; // Resume mining with new challenge
                document.getElementById('mine-btn').innerText = "STOP MINING";
                mineLoop();
            }
        });
    }

    function log(msg) {
        const el = document.getElementById('log');
        el.innerHTML += `<div>${msg}</div>`;
        el.scrollTop = el.scrollHeight;
    }
</script>

</body>
</html>