<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pro Text Editor | Yaroslav Ostapenko</title>
    <meta name="description" content="Advanced online text and markdown editor with multi-tab support, live preview, and file management." />
    
    <!-- Tailwind CSS (via CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons (via CDN) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">

    <style>
        /* 
         * ==========================================
         * CORE THEME VARIABLES
         * ==========================================
         */
        :root {
            --font-ui: 'Inter', system-ui, -apple-system, sans-serif;
            --font-editor: 'Fira Code', 'Courier New', monospace;
            
            /* Default Theme (Light) */
            --bg-body: #f8fafc;
            --bg-sidebar: #e2e8f0;
            --bg-panel: #ffffff;
            --bg-active-tab: #ffffff;
            --bg-inactive-tab: #cbd5e1;
            --bg-gutter: #f1f5f9;
            --bg-selection: #b3d4fc;
            --text-primary: #0f172a;
            --text-secondary: #64748b;
            --text-gutter: #94a3b8;
            --border-color: #cbd5e1;
            --accent-color: #3b82f6;
            --accent-hover: #2563eb;
            --scrollbar-thumb: #cbd5e1;
        }

        [data-theme="dark"] {
            --bg-body: #0f172a;
            --bg-sidebar: #1e293b;
            --bg-panel: #1e293b; /* Unified dark bg */
            --bg-active-tab: #1e293b;
            --bg-inactive-tab: #0f172a;
            --bg-gutter: #1e293b;
            --bg-selection: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-gutter: #475569;
            --border-color: #334155;
            --accent-color: #60a5fa;
            --accent-hover: #93c5fd;
            --scrollbar-thumb: #475569;
        }

        [data-theme="midnight"] {
            --bg-body: #000000;
            --bg-sidebar: #111111;
            --bg-panel: #0a0a0a;
            --bg-active-tab: #0a0a0a;
            --bg-inactive-tab: #111111;
            --bg-gutter: #000000;
            --bg-selection: #222222;
            --text-primary: #00ff41; /* Hacker Green */
            --text-secondary: #008f11;
            --text-gutter: #333333;
            --border-color: #333333;
            --accent-color: #00ff41;
            --accent-hover: #00cc33;
            --scrollbar-thumb: #333333;
        }

        [data-theme="coffee"] {
            --bg-body: #2b2726;
            --bg-sidebar: #221e1d;
            --bg-panel: #2b2726;
            --bg-active-tab: #2b2726;
            --bg-inactive-tab: #1e1b1a;
            --bg-gutter: #221e1d;
            --bg-selection: #4a3f3b;
            --text-primary: #dcd3cb;
            --text-secondary: #9c928c;
            --text-gutter: #5e5652;
            --border-color: #453d3a;
            --accent-color: #d4a373;
            --accent-hover: #faedcd;
            --scrollbar-thumb: #453d3a;
        }

        /* Global Reset */
        * { box-sizing: border-box; }
        body {
            font-family: var(--font-ui);
            background-color: var(--bg-body);
            color: var(--text-primary);
            margin: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Scrollbars */
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 5px; border: 2px solid var(--bg-body); }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-secondary); }

        /* Utilities */
        .hidden { display: none !important; }
        .flex-center { display: flex; align-items: center; justify-content: center; }
        .icon-btn { 
            padding: 0.5rem; 
            border-radius: 0.375rem; 
            cursor: pointer; 
            color: var(--text-secondary); 
            transition: all 0.2s; 
        }
        .icon-btn:hover { background-color: rgba(128,128,128,0.1); color: var(--text-primary); }
        .icon-btn.active { background-color: rgba(var(--accent-color), 0.2); color: var(--accent-color); }

        /* 
         * ==========================================
         * LAYOUT COMPONENTS
         * ==========================================
         */

        /* Header */
        header {
            height: 50px;
            background-color: var(--bg-sidebar);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1rem;
            flex-shrink: 0;
        }

        /* Sidebar (File Explorer) */
        #sidebar {
            width: 250px;
            background-color: var(--bg-sidebar);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            transition: width 0.3s ease;
            flex-shrink: 0;
        }
        #sidebar.collapsed { width: 0; overflow: hidden; border: none; }

        /* Main Workspace */
        #workspace {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background-color: var(--bg-panel);
        }

        /* Tab Bar */
        #tab-bar {
            height: 40px;
            background-color: var(--bg-sidebar);
            display: flex;
            align-items: flex-end;
            padding-left: 0.5rem;
            border-bottom: 1px solid var(--border-color);
            overflow-x: auto;
        }
        
        .tab {
            padding: 0.5rem 1rem;
            background-color: var(--bg-inactive-tab);
            color: var(--text-secondary);
            font-size: 0.85rem;
            border-top-left-radius: 0.375rem;
            border-top-right-radius: 0.375rem;
            margin-right: 2px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            border: 1px solid transparent;
            border-bottom: none;
            user-select: none;
            max-width: 200px;
        }
        .tab:hover { background-color: rgba(128,128,128,0.05); }
        .tab.active {
            background-color: var(--bg-active-tab);
            color: var(--text-primary);
            border-color: var(--border-color);
            font-weight: 500;
            border-bottom: 1px solid var(--bg-active-tab);
            margin-bottom: -1px;
            z-index: 10;
        }
        .tab .close-tab { opacity: 0; font-size: 1rem; border-radius: 50%; padding: 0 2px; }
        .tab:hover .close-tab { opacity: 1; }
        .tab .close-tab:hover { background-color: rgba(255, 0, 0, 0.2); color: red; }

        /* Editor Toolbar */
        #toolbar {
            height: 40px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 1rem;
            gap: 0.5rem;
            background-color: var(--bg-panel);
        }
        .divider { width: 1px; height: 20px; background-color: var(--border-color); margin: 0 0.5rem; }

        /* Split View Area */
        #editor-container {
            flex-grow: 1;
            display: flex;
            position: relative;
            overflow: hidden;
        }

        /* Gutter (Line Numbers) */
        #gutter {
            width: 50px;
            background-color: var(--bg-gutter);
            border-right: 1px solid var(--border-color);
            color: var(--text-gutter);
            font-family: var(--font-editor);
            font-size: 14px;
            line-height: 1.5;
            text-align: right;
            padding: 10px 8px;
            user-select: none;
            overflow: hidden;
            flex-shrink: 0;
        }

        /* Text Input */
        #code-area {
            flex-grow: 1;
            background-color: var(--bg-panel);
            color: var(--text-primary);
            border: none;
            outline: none;
            resize: none;
            font-family: var(--font-editor);
            font-size: 14px;
            line-height: 1.5;
            padding: 10px;
            white-space: pre;
            overflow: auto;
            tab-size: 4;
        }

        /* Preview Pane */
        #preview-pane {
            width: 50%;
            background-color: var(--bg-body);
            border-left: 1px solid var(--border-color);
            padding: 20px;
            overflow-y: auto;
            display: none; /* Hidden by default */
        }
        #preview-pane.visible { display: block; }
        
        /* Markdown Styles within Preview */
        #preview-pane h1 { font-size: 2em; font-weight: bold; margin-bottom: 0.5em; border-bottom: 1px solid var(--border-color); padding-bottom: 0.3em; }
        #preview-pane h2 { font-size: 1.5em; font-weight: bold; margin-bottom: 0.5em; margin-top: 1em; }
        #preview-pane p { margin-bottom: 1em; line-height: 1.6; }
        #preview-pane code { background-color: var(--bg-sidebar); padding: 0.2em 0.4em; border-radius: 3px; font-family: var(--font-editor); font-size: 0.9em; }
        #preview-pane pre { background-color: var(--bg-sidebar); padding: 1em; border-radius: 5px; overflow-x: auto; margin-bottom: 1em; }
        #preview-pane pre code { background-color: transparent; padding: 0; }
        #preview-pane blockquote { border-left: 4px solid var(--accent-color); padding-left: 1em; margin-left: 0; color: var(--text-secondary); }
        #preview-pane ul { list-style-type: disc; padding-left: 2em; margin-bottom: 1em; }
        #preview-pane ol { list-style-type: decimal; padding-left: 2em; margin-bottom: 1em; }
        #preview-pane a { color: var(--accent-color); text-decoration: underline; }
        #preview-pane img { max-width: 100%; border-radius: 5px; }
        #preview-pane hr { border: none; border-top: 1px solid var(--border-color); margin: 2em 0; }

        /* Footer / Status Bar */
        footer {
            height: 30px;
            background-color: var(--bg-sidebar);
            border-top: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
            user-select: none;
            flex-shrink: 0;
        }

        /* Search Overlay */
        #search-box {
            position: absolute;
            top: 10px;
            right: 20px;
            background-color: var(--bg-panel);
            border: 1px solid var(--border-color);
            padding: 10px;
            border-radius: 6px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 5px;
            align-items: center;
            z-index: 50;
            transform: translateY(-150%);
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        #search-box.visible { transform: translateY(0); }
        #search-box input {
            background-color: var(--bg-body);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9rem;
            outline: none;
        }
        #search-box input:focus { border-color: var(--accent-color); }

        /* Modal Overlay */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }
        .modal-overlay.open { opacity: 1; pointer-events: auto; }
        .modal {
            background-color: var(--bg-panel);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            width: 400px;
            max-width: 90vw;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            transform: scale(0.95);
            transition: transform 0.2s;
        }
        .modal-overlay.open .modal { transform: scale(1); }
        
        /* Mobile Adjustments */
        @media (max-width: 640px) {
            #sidebar { position: absolute; height: 100%; z-index: 40; box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
            #sidebar.collapsed { width: 0; }
            #preview-pane.visible { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 30; }
            .hidden-mobile { display: none; }
        }
    </style>
</head>
<body data-theme="light">

    <!-- Header -->
    <header>
        <div class="flex items-center gap-3">
            <button id="toggle-sidebar" class="icon-btn" title="Toggle Sidebar">
                <i data-lucide="menu" width="20"></i>
            </button>
            <div class="flex items-center gap-2 font-semibold text-lg tracking-tight">
                <i data-lucide="pen-tool" class="text-blue-500"></i>
                <span>ProEditor</span>
            </div>
        </div>
        <div class="flex items-center gap-2">
            <button onclick="app.downloadFile()" class="icon-btn bg-blue-600 !text-white hover:bg-blue-700 font-medium text-sm px-4 py-1.5 flex items-center gap-2 rounded-full transition-colors shadow-sm">
                <i data-lucide="download" width="16"></i> Export
            </button>
            <div class="divider"></div>
            <button onclick="app.toggleTheme()" class="icon-btn" title="Switch Theme">
                <i data-lucide="moon" width="20"></i>
            </button>
            <button onclick="app.openSettings()" class="icon-btn" title="Settings">
                <i data-lucide="settings" width="20"></i>
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <div class="flex flex-grow overflow-hidden">
        
        <!-- Sidebar -->
        <aside id="sidebar">
            <div class="p-3 font-semibold text-xs uppercase tracking-wider text-gray-500 border-b border-[var(--border-color)] flex justify-between items-center">
                <span>Explorer</span>
                <button onclick="app.newFile()" class="icon-btn p-1" title="New File"><i data-lucide="plus" width="14"></i></button>
            </div>
            <div id="file-list" class="flex-grow overflow-y-auto p-2 space-y-1">
                <!-- File items generated by JS -->
            </div>
            <div class="p-3 border-t border-[var(--border-color)]">
                <label class="flex items-center gap-2 cursor-pointer hover:text-[var(--accent-color)] transition-colors text-sm">
                    <i data-lucide="upload" width="16"></i>
                    <span>Open Local File</span>
                    <input type="file" id="file-upload" class="hidden" accept=".txt,.md,.html,.js,.css,.json">
                </label>
            </div>
        </aside>

        <!-- Workspace -->
        <section id="workspace">
            
            <!-- Tabs -->
            <div id="tab-bar">
                <!-- Tabs generated by JS -->
            </div>

            <!-- Toolbar -->
            <div id="toolbar">
                <button onclick="app.insertMarkdown('**', '**')" class="icon-btn" title="Bold"><i data-lucide="bold" width="16"></i></button>
                <button onclick="app.insertMarkdown('*', '*')" class="icon-btn" title="Italic"><i data-lucide="italic" width="16"></i></button>
                <button onclick="app.insertMarkdown('~~', '~~')" class="icon-btn" title="Strikethrough"><i data-lucide="strikethrough" width="16"></i></button>
                <div class="divider"></div>
                <button onclick="app.insertMarkdown('# ')" class="icon-btn" title="Heading 1"><i data-lucide="heading-1" width="16"></i></button>
                <button onclick="app.insertMarkdown('## ')" class="icon-btn" title="Heading 2"><i data-lucide="heading-2" width="16"></i></button>
                <div class="divider"></div>
                <button onclick="app.insertMarkdown('- ')" class="icon-btn" title="List"><i data-lucide="list" width="16"></i></button>
                <button onclick="app.insertMarkdown('> ')" class="icon-btn" title="Quote"><i data-lucide="quote" width="16"></i></button>
                <button onclick="app.insertMarkdown('```\n', '\n```')" class="icon-btn" title="Code Block"><i data-lucide="code" width="16"></i></button>
                <div class="divider"></div>
                <button onclick="app.togglePreview()" id="btn-preview" class="icon-btn ml-auto flex items-center gap-2 px-3 border border-[var(--border-color)]" title="Toggle Preview">
                    <i data-lucide="eye" width="16"></i> <span class="text-xs font-medium">Preview</span>
                </button>
            </div>

            <!-- Editor & Preview -->
            <div id="editor-container">
                <div id="gutter">1</div>
                <textarea id="code-area" spellcheck="false" placeholder="Start typing..."></textarea>
                
                <!-- Preview Pane -->
                <div id="preview-pane"></div>

                <!-- Search Overlay -->
                <div id="search-box">
                    <input type="text" id="search-input" placeholder="Find...">
                    <input type="text" id="replace-input" placeholder="Replace...">
                    <button onclick="app.findNext()" class="icon-btn"><i data-lucide="arrow-down" width="16"></i></button>
                    <button onclick="app.replaceOne()" class="icon-btn" title="Replace"><i data-lucide="replace" width="16"></i></button>
                    <button onclick="app.replaceAll()" class="icon-btn" title="Replace All"><i data-lucide="replace-all" width="16"></i></button>
                    <button onclick="app.closeSearch()" class="icon-btn text-red-500"><i data-lucide="x" width="16"></i></button>
                </div>
            </div>

        </section>
    </div>

    <!-- Footer -->
    <footer>
        <div class="flex items-center gap-4">
            <span id="stat-lines">0 lines</span>
            <span id="stat-words">0 words</span>
            <span id="stat-chars">0 chars</span>
        </div>
        <div class="flex items-center gap-4">
            <span id="stat-readtime">0 min read</span>
            <span class="opacity-50">UTF-8</span>
        </div>
    </footer>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal-overlay">
        <div class="modal">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Settings</h2>
                <button onclick="app.closeSettings()" class="icon-btn"><i data-lucide="x"></i></button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1 text-[var(--text-secondary)]">Theme</label>
                    <select id="theme-select" class="w-full p-2 rounded border border-[var(--border-color)] bg-[var(--bg-body)] text-[var(--text-primary)]">
                        <option value="light">Light</option>
                        <option value="dark">Dark</option>
                        <option value="midnight">Midnight (Hacker)</option>
                        <option value="coffee">Coffee</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1 text-[var(--text-secondary)]">Font Size</label>
                    <input type="range" id="font-size-range" min="10" max="24" value="14" class="w-full">
                    <div class="text-xs text-right text-[var(--text-secondary)]" id="font-size-val">14px</div>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-sm font-medium">Show Line Numbers</span>
                    <input type="checkbox" id="toggle-gutter" checked class="accent-blue-500">
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-sm font-medium">Word Wrap</span>
                    <input type="checkbox" id="toggle-wrap" class="accent-blue-500">
                </div>
            </div>
            
            <div class="mt-6 pt-4 border-t border-[var(--border-color)] flex justify-end">
                <button onclick="app.clearAllData()" class="text-red-500 text-sm hover:underline">Reset All Data</button>
            </div>
        </div>
    </div>

    <!-- Script Logic -->
    <script>
        // ============================================================================
        //  MODULE: HELPER UTILS
        // ============================================================================
        const $ = (selector) => document.querySelector(selector);
        const $$ = (selector) => document.querySelectorAll(selector);
        const uuid = () => Date.now().toString(36) + Math.random().toString(36).substr(2);

        // ============================================================================
        //  MODULE: MARKDOWN PARSER (Custom Implementation)
        // ============================================================================
        class MarkdownParser {
            constructor() {
                this.rules = [
                    { regex: /^# (.*$)/gim, replacement: '<h1>$1</h1>' },
                    { regex: /^## (.*$)/gim, replacement: '<h2>$1</h2>' },
                    { regex: /^### (.*$)/gim, replacement: '<h3>$1</h3>' },
                    { regex: /\*\*(.*)\*\*/gim, replacement: '<b>$1</b>' },
                    { regex: /\*(.*)\*/gim, replacement: '<i>$1</i>' },
                    { regex: /~~(.*)~~/gim, replacement: '<del>$1</del>' },
                    { regex: /`(.*?)`/gim, replacement: '<code>$1</code>' },
                    { regex: /!\[(.*?)\]\((.*?)\)/gim, replacement: '<img src="$2" alt="$1" />' },
                    { regex: /\[(.*?)\]\((.*?)\)/gim, replacement: '<a href="$2" target="_blank">$1</a>' },
                    { regex: /^> (.*$)/gim, replacement: '<blockquote>$1</blockquote>' },
                    { regex: /^- (.*$)/gim, replacement: '<ul><li>$1</li></ul>' }, // Simplified list
                    { regex: /^\d+\. (.*$)/gim, replacement: '<ol><li>$1</li></ol>' }, // Simplified list
                    { regex: /\n/gim, replacement: '<br />' }
                ];
            }

            parse(text) {
                // Escape HTML tags to prevent injection (basic sanitization)
                let output = text.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                
                // Code blocks (Pre-processing to avoid formatting inside code)
                const codeBlocks = [];
                output = output.replace(/```([\s\S]*?)```/g, (match, code) => {
                    codeBlocks.push(`<pre><code>${code.trim()}</code></pre>`);
                    return `__CODEBLOCK_${codeBlocks.length - 1}__`;
                });

                // Apply standard rules
                this.rules.forEach(rule => {
                    output = output.replace(rule.regex, rule.replacement);
                });

                // Fix lists (merge adjacent ul/ol)
                output = output.replace(/<\/ul><br \/><ul>/g, '');
                output = output.replace(/<\/ol><br \/><ol>/g, '');

                // Restore code blocks
                output = output.replace(/__CODEBLOCK_(\d+)__/g, (match, index) => codeBlocks[index]);

                return output;
            }
        }

        // ============================================================================
        //  MODULE: EDITOR APP CORE
        // ============================================================================
        class ProEditor {
            constructor() {
                this.files = [];
                this.activeFileId = null;
                this.mdParser = new MarkdownParser();
                
                // DOM Elements
                this.ui = {
                    codeArea: $('#code-area'),
                    gutter: $('#gutter'),
                    fileList: $('#file-list'),
                    tabBar: $('#tab-bar'),
                    preview: $('#preview-pane'),
                    searchBox: $('#search-box'),
                    searchInput: $('#search-input'),
                    replaceInput: $('#replace-input'),
                    modals: {
                        settings: $('#settings-modal')
                    }
                };

                // Settings
                this.settings = JSON.parse(localStorage.getItem('pe_settings')) || {
                    theme: 'light',
                    fontSize: 14,
                    showGutter: true,
                    wordWrap: false
                };

                this.init();
            }

            init() {
                this.loadFiles();
                this.applySettings();
                this.bindEvents();
                lucide.createIcons();
                
                // Auto-create welcome file if empty
                if (this.files.length === 0) {
                    this.createFile('Welcome.md', '# Welcome to ProEditor\n\nThis is a simple, powerful text editor.\n\n- [x] Multi-tabs\n- [x] Markdown Preview\n- [x] Themes\n\nStart typing!');
                }
                
                // Activate last active file or first
                const lastActive = localStorage.getItem('pe_active_id');
                if (this.files.find(f => f.id === lastActive)) {
                    this.switchTab(lastActive);
                } else {
                    this.switchTab(this.files[0].id);
                }
            }

            // --- File Management ---

            createFile(name = 'Untitled.txt', content = '') {
                const file = {
                    id: uuid(),
                    name: name,
                    content: content,
                    timestamp: Date.now()
                };
                this.files.push(file);
                this.saveStorage();
                this.renderTabs();
                this.renderFileList();
                this.switchTab(file.id);
            }

            deleteFile(id, e) {
                if(e) e.stopPropagation();
                if (!confirm('Delete this file?')) return;
                
                this.files = this.files.filter(f => f.id !== id);
                if (this.activeFileId === id) {
                    this.activeFileId = this.files.length > 0 ? this.files[0].id : null;
                }
                
                if (this.files.length === 0) this.createFile(); // Always have 1 file
                
                this.saveStorage();
                this.renderTabs();
                this.renderFileList();
                if (this.activeFileId) this.switchTab(this.activeFileId);
            }

            switchTab(id) {
                this.activeFileId = id;
                localStorage.setItem('pe_active_id', id);
                
                const file = this.getActiveFile();
                if (!file) return;

                this.ui.codeArea.value = file.content;
                this.updateStats();
                this.updatePreview();
                this.updateGutter();
                this.renderTabs();
            }

            getActiveFile() {
                return this.files.find(f => f.id === this.activeFileId);
            }

            saveContent() {
                const file = this.getActiveFile();
                if (file) {
                    file.content = this.ui.codeArea.value;
                    this.saveStorage();
                    this.updateStats();
                    this.updatePreview();
                }
            }

            saveStorage() {
                localStorage.setItem('pe_files', JSON.stringify(this.files));
            }

            loadFiles() {
                const stored = localStorage.getItem('pe_files');
                if (stored) {
                    this.files = JSON.parse(stored);
                }
            }

            // --- UI Rendering ---

            renderTabs() {
                this.ui.tabBar.innerHTML = this.files.map(file => `
                    <div class="tab ${file.id === this.activeFileId ? 'active' : ''}" onclick="app.switchTab('${file.id}')">
                        <i data-lucide="file-text" width="14"></i>
                        <span class="truncate max-w-[100px]">${file.name}</span>
                        <span class="close-tab" onclick="app.deleteFile('${file.id}', event)">Ã—</span>
                    </div>
                `).join('');
                lucide.createIcons();
            }

            renderFileList() {
                this.ui.fileList.innerHTML = this.files.map(file => `
                    <div class="p-2 text-sm rounded cursor-pointer flex items-center gap-2 hover:bg-[var(--bg-active-tab)] ${file.id === this.activeFileId ? 'bg-[var(--bg-active-tab)] font-medium text-[var(--accent-color)]' : 'text-[var(--text-secondary)]'}" onclick="app.switchTab('${file.id}')">
                        <i data-lucide="${file.name.endsWith('.md') ? 'file-code' : 'file-text'}" width="16"></i>
                        <span class="truncate">${file.name}</span>
                    </div>
                `).join('');
                lucide.createIcons();
            }

            updateGutter() {
                if (!this.settings.showGutter) return;
                const lines = this.ui.codeArea.value.split('\n').length;
                this.ui.gutter.innerHTML = Array(lines).fill(0).map((_, i) => `<div>${i + 1}</div>`).join('');
            }

            updateStats() {
                const text = this.ui.codeArea.value;
                const lines = text.split('\n').length;
                const words = text.trim() === '' ? 0 : text.trim().split(/\s+/).length;
                const chars = text.length;
                const readTime = Math.ceil(words / 200);

                $('#stat-lines').textContent = `${lines} lines`;
                $('#stat-words').textContent = `${words} words`;
                $('#stat-chars').textContent = `${chars} chars`;
                $('#stat-readtime').textContent = `${readTime} min read`;
                
                // Sync scroll
                this.updateGutter();
            }

            updatePreview() {
                if (this.ui.preview.classList.contains('visible')) {
                    const html = this.mdParser.parse(this.ui.codeArea.value);
                    this.ui.preview.innerHTML = html;
                }
            }

            // --- Features ---

            insertMarkdown(prefix, suffix = '') {
                const area = this.ui.codeArea;
                const start = area.selectionStart;
                const end = area.selectionEnd;
                const text = area.value;
                const selection = text.substring(start, end);
                
                const replacement = prefix + selection + suffix;
                area.value = text.substring(0, start) + replacement + text.substring(end);
                
                area.focus();
                area.selectionEnd = start + prefix.length + selection.length;
                
                this.saveContent();
            }

            togglePreview() {
                this.ui.preview.classList.toggle('visible');
                $('#btn-preview').classList.toggle('active');
                if (this.ui.preview.classList.contains('visible')) {
                    this.updatePreview();
                }
            }

            newFile() {
                const name = prompt('Enter file name:', 'Untitled.txt');
                if (name) this.createFile(name);
            }

            downloadFile() {
                const file = this.getActiveFile();
                if (!file) return;
                
                const blob = new Blob([file.content], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = file.name;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            openLocalFile(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (ev) => {
                    this.createFile(file.name, ev.target.result);
                };
                reader.readAsText(file);
                e.target.value = ''; // Reset input
            }

            // --- Search & Replace ---

            toggleSearch() {
                this.ui.searchBox.classList.toggle('visible');
                if (this.ui.searchBox.classList.contains('visible')) {
                    this.ui.searchInput.focus();
                }
            }

            closeSearch() {
                this.ui.searchBox.classList.remove('visible');
            }

            findNext() {
                const query = this.ui.searchInput.value;
                if (!query) return;
                
                const text = this.ui.codeArea.value;
                const start = this.ui.codeArea.selectionEnd;
                const index = text.indexOf(query, start);
                
                if (index !== -1) {
                    this.ui.codeArea.setSelectionRange(index, index + query.length);
                    this.ui.codeArea.focus();
                } else {
                    // Loop around
                    const wrapIndex = text.indexOf(query, 0);
                    if (wrapIndex !== -1) {
                        this.ui.codeArea.setSelectionRange(wrapIndex, wrapIndex + query.length);
                        this.ui.codeArea.focus();
                    } else {
                        alert('Not found');
                    }
                }
            }

            replaceOne() {
                const query = this.ui.searchInput.value;
                const replacement = this.ui.replaceInput.value;
                const area = this.ui.codeArea;
                
                if (area.value.substring(area.selectionStart, area.selectionEnd) === query) {
                    document.execCommand('insertText', false, replacement);
                    this.saveContent();
                } else {
                    this.findNext();
                }
            }

            replaceAll() {
                const query = this.ui.searchInput.value;
                const replacement = this.ui.replaceInput.value;
                if (!query) return;
                
                const text = this.ui.codeArea.value;
                const newText = text.split(query).join(replacement);
                this.ui.codeArea.value = newText;
                this.saveContent();
            }

            // --- Settings & Themes ---

            openSettings() { this.ui.modals.settings.classList.add('open'); }
            closeSettings() { this.ui.modals.settings.classList.remove('open'); }

            applySettings() {
                document.body.setAttribute('data-theme', this.settings.theme);
                this.ui.codeArea.style.fontSize = `${this.settings.fontSize}px`;
                this.ui.gutter.style.fontSize = `${this.settings.fontSize}px`;
                
                if (this.settings.showGutter) {
                    this.ui.gutter.classList.remove('hidden');
                } else {
                    this.ui.gutter.classList.add('hidden');
                }

                if (this.settings.wordWrap) {
                    this.ui.codeArea.style.whiteSpace = 'pre-wrap';
                } else {
                    this.ui.codeArea.style.whiteSpace = 'pre';
                }

                // Update Input values in modal
                $('#theme-select').value = this.settings.theme;
                $('#font-size-range').value = this.settings.fontSize;
                $('#font-size-val').textContent = `${this.settings.fontSize}px`;
                $('#toggle-gutter').checked = this.settings.showGutter;
                $('#toggle-wrap').checked = this.settings.wordWrap;
            }

            toggleTheme() {
                const themes = ['light', 'dark', 'midnight', 'coffee'];
                let current = themes.indexOf(this.settings.theme);
                this.settings.theme = themes[(current + 1) % themes.length];
                this.updateSettings();
            }

            updateSettings() {
                localStorage.setItem('pe_settings', JSON.stringify(this.settings));
                this.applySettings();
            }

            clearAllData() {
                if (confirm('Are you sure? This will delete all files and settings.')) {
                    localStorage.removeItem('pe_files');
                    localStorage.removeItem('pe_settings');
                    localStorage.removeItem('pe_active_id');
                    location.reload();
                }
            }

            // --- Event Binding ---

            bindEvents() {
                // Code Area events
                this.ui.codeArea.addEventListener('input', () => this.saveContent());
                this.ui.codeArea.addEventListener('scroll', () => {
                    this.ui.gutter.scrollTop = this.ui.codeArea.scrollTop;
                });
                
                // Keyboard Shortcuts
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey || e.metaKey) {
                        switch(e.key.toLowerCase()) {
                            case 's': e.preventDefault(); this.downloadFile(); break;
                            case 'f': e.preventDefault(); this.toggleSearch(); break;
                            case 'b': e.preventDefault(); $('#toggle-sidebar').click(); break;
                        }
                    }
                });

                // Sidebar Toggle
                $('#toggle-sidebar').addEventListener('click', () => {
                    $('#sidebar').classList.toggle('collapsed');
                });

                // File Upload
                $('#file-upload').addEventListener('change', (e) => this.openLocalFile(e));

                // Settings Inputs
                $('#theme-select').addEventListener('change', (e) => {
                    this.settings.theme = e.target.value;
                    this.updateSettings();
                });
                $('#font-size-range').addEventListener('input', (e) => {
                    this.settings.fontSize = e.target.value;
                    this.updateSettings();
                });
                $('#toggle-gutter').addEventListener('change', (e) => {
                    this.settings.showGutter = e.target.checked;
                    this.updateSettings();
                });
                $('#toggle-wrap').addEventListener('change', (e) => {
                    this.settings.wordWrap = e.target.checked;
                    this.updateSettings();
                });
            }
        }

        // Initialize App
        const app = new ProEditor();

    </script>
</body>
</html>