<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>VS Code Web | Yaroslav Ostapenko</title>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@300;400;600&family=Consolas:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* 
         * ==========================================
         *  VS CODE THEME VARIABLES
         * ==========================================
         */
        :root {
            --bg-app: #1e1e1e;
            --bg-activity-bar: #333333;
            --bg-sidebar: #252526;
            --bg-editor: #1e1e1e;
            --bg-panel: #1e1e1e;
            --bg-status-bar: #007acc;
            --bg-title-bar: #3c3c3c;
            --bg-menu: #252526;
            --bg-input: #3c3c3c;
            
            --border-color: #454545;
            --focus-border: #007acc;
            
            --text-primary: #cccccc;
            --text-secondary: #969696;
            --text-inverse: #ffffff;
            
            --highlight-line: #2d2d30;
            --selection: #264f78;
            --hover-item: #2a2d2e;
            --active-item: #37373d;
            
            /* Syntax Colors (Dark+) */
            --syn-comment: #6a9955;
            --syn-string: #ce9178;
            --syn-keyword: #569cd6;
            --syn-control: #c586c0;
            --syn-function: #dcdcaa;
            --syn-variable: #9cdcfe;
            --syn-type: #4ec9b0;
            --syn-class: #4ec9b0;
            --syn-number: #b5cea8;
            --syn-tag: #569cd6;
            --syn-attr: #9cdcfe;
            
            --font-ui: 'Segoe UI', system-ui, sans-serif;
            --font-code: 'Consolas', 'Courier New', monospace;
        }

        * { box-sizing: border-box; outline: none; user-select: none; }
        
        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-app);
            color: var(--text-primary);
            font-family: var(--font-ui);
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Scrollbars */
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #424242; }
        ::-webkit-scrollbar-thumb:hover { background: #4f4f4f; }
        ::-webkit-scrollbar-corner { background: transparent; }

        /* ================= LAYOUT ================= */
        
        /* 1. Title Bar */
        #title-bar {
            height: 30px;
            background-color: var(--bg-title-bar);
            display: flex;
            align-items: center;
            padding: 0 10px;
            font-size: 13px;
            justify-content: center;
            position: relative;
            -webkit-app-region: drag;
        }
        .window-controls { position: absolute; right: 0; display: flex; height: 100%; }
        .win-btn { width: 45px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .win-btn:hover { background-color: rgba(255,255,255,0.1); }
        .win-btn.close:hover { background-color: #e81123; }
        
        .menu-bar { position: absolute; left: 0; display: flex; height: 100%; align-items: center; padding-left: 10px; }
        .menu-item { padding: 0 8px; cursor: pointer; color: var(--text-primary); }
        .menu-item:hover { color: var(--text-inverse); }

        /* 2. Main Workbench */
        #workbench {
            display: flex;
            flex-grow: 1;
            overflow: hidden;
        }

        /* Activity Bar */
        #activity-bar {
            width: 48px;
            background-color: var(--bg-activity-bar);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 10px;
        }
        .activity-icon {
            width: 48px;
            height: 48px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            opacity: 0.6;
            border-left: 2px solid transparent;
        }
        .activity-icon:hover { opacity: 1; }
        .activity-icon.active { opacity: 1; border-left-color: var(--text-inverse); }

        /* Sidebar */
        #sidebar {
            width: 250px;
            background-color: var(--bg-sidebar);
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border-color);
        }
        .sidebar-header {
            height: 35px;
            padding: 0 20px;
            display: flex;
            align-items: center;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
            justify-content: space-between;
        }
        .sidebar-actions i { cursor: pointer; margin-left: 5px; }
        .sidebar-actions i:hover { color: var(--text-inverse); }

        #explorer-tree {
            flex-grow: 1;
            overflow-y: auto;
            padding-top: 5px;
        }
        .tree-node {
            display: flex;
            align-items: center;
            padding: 3px 0;
            cursor: pointer;
            font-size: 13px;
            color: var(--text-primary);
            border: 1px solid transparent;
        }
        .tree-node:hover { background-color: var(--hover-item); }
        .tree-node.selected { background-color: var(--active-item); border-color: var(--focus-border); }
        .tree-indent { width: 10px; }
        .node-icon { margin: 0 5px; width: 16px; display: flex; justify-content: center; }
        .node-arrow { margin: 0 2px; width: 16px; display: flex; justify-content: center; transform: rotate(0deg); transition: transform 0.1s; }
        .node-arrow.open { transform: rotate(90deg); }

        /* Editor Area */
        #editor-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            background-color: var(--bg-editor);
            position: relative;
        }

        /* Tabs */
        #tabs-container {
            height: 35px;
            background-color: var(--bg-menu);
            display: flex;
            overflow-x: auto;
        }
        .tab {
            height: 100%;
            display: flex;
            align-items: center;
            padding: 0 15px;
            font-size: 13px;
            color: var(--text-secondary);
            background-color: #2d2d2d;
            border-right: 1px solid var(--bg-editor);
            cursor: pointer;
            min-width: 120px;
            max-width: 200px;
            position: relative;
        }
        .tab.active { background-color: var(--bg-editor); color: var(--text-inverse); border-top: 2px solid var(--focus-border); }
        .tab-close { margin-left: auto; opacity: 0; padding: 2px; border-radius: 3px; }
        .tab:hover .tab-close { opacity: 1; }
        .tab-close:hover { background-color: rgba(255,255,255,0.2); }

        /* Code Editor Wrapper */
        #code-wrapper {
            position: relative;
            flex-grow: 1;
            display: flex;
            overflow: hidden;
        }

        /* Line Numbers */
        #gutter {
            width: 50px;
            background-color: var(--bg-editor);
            color: #858585;
            font-family: var(--font-code);
            font-size: 14px;
            line-height: 1.5;
            text-align: right;
            padding: 10px 15px 10px 0;
            flex-shrink: 0;
        }

        /* Main Input & Render */
        .editor-layer {
            position: absolute;
            top: 0; left: 50px; right: 100px; bottom: 0; /* right 100px for minimap */
            padding: 10px;
            font-family: var(--font-code);
            font-size: 14px;
            line-height: 1.5;
            white-space: pre;
            tab-size: 4;
            overflow: auto;
        }
        textarea#code-input {
            z-index: 2;
            color: transparent;
            background: transparent;
            border: none;
            resize: none;
            caret-color: var(--text-inverse);
            user-select: text;
        }
        #code-render {
            z-index: 1;
            pointer-events: none;
        }

        /* Minimap */
        #minimap {
            position: absolute;
            top: 0; right: 0; bottom: 0;
            width: 100px;
            background-color: var(--bg-editor);
            border-left: 1px solid var(--border-color);
            z-index: 5;
            overflow: hidden;
            opacity: 0.8;
        }
        #minimap canvas { width: 100%; height: 100%; }
        #minimap-slider {
            position: absolute;
            left: 0; right: 0;
            background-color: rgba(120, 120, 120, 0.2);
            transition: background-color 0.1s;
            cursor: default;
        }
        #minimap-slider:hover { background-color: rgba(120, 120, 120, 0.4); }

        /* Status Bar */
        #status-bar {
            height: 22px;
            background-color: var(--bg-status-bar);
            color: var(--text-inverse);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 10px;
            font-size: 12px;
            z-index: 50;
        }
        .status-item { margin-left: 15px; cursor: pointer; display: flex; align-items: center; gap: 5px; }
        .status-item:hover { opacity: 0.8; }

        /* ================= COMPONENTS ================= */

        /* Context Menu */
        .context-menu {
            position: fixed;
            background-color: var(--bg-menu);
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 8px rgba(0,0,0,0.5);
            padding: 5px 0;
            min-width: 180px;
            z-index: 9999;
            display: none;
        }
        .context-item {
            padding: 6px 20px;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
        }
        .context-item:hover { background-color: var(--selection); color: white; }
        .context-separator { height: 1px; background-color: var(--border-color); margin: 4px 0; }

        /* Syntax Highlighting Classes */
        .tok-kw { color: var(--syn-keyword); font-weight: bold; }
        .tok-str { color: var(--syn-string); }
        .tok-com { color: var(--syn-comment); font-style: italic; }
        .tok-num { color: var(--syn-number); }
        .tok-typ { color: var(--syn-type); }
        .tok-func { color: var(--syn-function); }
        .tok-var { color: var(--syn-variable); }
        .tok-tag { color: var(--syn-tag); }
        .tok-attr { color: var(--syn-attr); }
        .tok-ctrl { color: var(--syn-control); }

        /* Modal / Dialog */
        #modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 2000;
            display: none; justify-content: center; padding-top: 100px;
        }
        .modal-box {
            background: var(--bg-panel); width: 400px; padding: 15px;
            border: 1px solid var(--border-color); box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        .modal-header { font-weight: bold; margin-bottom: 10px; font-size: 14px; }
        .modal-input {
            width: 100%; background: var(--bg-input); border: 1px solid var(--border-color);
            color: var(--text-inverse); padding: 5px; margin-bottom: 10px;
        }
        .btn {
            background: var(--focus-border); color: white; border: none; padding: 5px 12px; cursor: pointer;
        }
        .btn:hover { opacity: 0.9; }
        .btn-secondary { background: #3c3c3c; margin-left: 5px; }

        /* File Upload Input (Hidden) */
        #file-upload-input { display: none; }

    </style>
</head>
<body>

    <!-- 1. Title Bar -->
    <div id="title-bar">
        <div class="menu-bar">
            <img src="https://upload.wikimedia.org/wikipedia/commons/9/9a/Visual_Studio_Code_1.35_icon.svg" width="18" style="margin-right: 10px;">
            <div class="menu-item" onclick="app.actions.triggerUpload()">File</div>
            <div class="menu-item">Edit</div>
            <div class="menu-item">Selection</div>
            <div class="menu-item">View</div>
            <div class="menu-item">Go</div>
            <div class="menu-item">Run</div>
            <div class="menu-item">Terminal</div>
            <div class="menu-item">Help</div>
        </div>
        <span id="title-text">Ultra IDE - Visual Studio Code</span>
        <div class="window-controls">
            <div class="win-btn">_</div>
            <div class="win-btn">□</div>
            <div class="win-btn close">✕</div>
        </div>
    </div>

    <!-- 2. Workbench -->
    <div id="workbench">
        
        <!-- Activity Bar -->
        <div id="activity-bar">
            <div class="activity-icon active" title="Explorer"><i data-lucide="files" width="24"></i></div>
            <div class="activity-icon" title="Search"><i data-lucide="search" width="24"></i></div>
            <div class="activity-icon" title="Source Control"><i data-lucide="git-branch" width="24"></i></div>
            <div class="activity-icon" title="Run and Debug"><i data-lucide="play" width="24"></i></div>
            <div class="activity-icon" title="Extensions"><i data-lucide="blocks" width="24"></i></div>
            <div style="flex-grow: 1"></div>
            <div class="activity-icon" title="Accounts"><i data-lucide="user-circle" width="24"></i></div>
            <div class="activity-icon" title="Manage" onclick="app.settings.open()"><i data-lucide="settings" width="24"></i></div>
        </div>

        <!-- Sidebar -->
        <div id="sidebar">
            <div class="sidebar-header">
                <span>Explorer</span>
                <div class="sidebar-actions">
                    <i data-lucide="file-plus" width="14" title="New File" onclick="app.vfs.createFile()"></i>
                    <i data-lucide="folder-plus" width="14" title="New Folder" onclick="app.vfs.createFolder()"></i>
                    <i data-lucide="refresh-cw" width="14" title="Refresh"></i>
                    <i data-lucide="upload" width="14" title="Upload Files" onclick="app.actions.triggerUpload()"></i>
                </div>
            </div>
            <div id="explorer-tree">
                <!-- Tree Content -->
            </div>
        </div>

        <!-- Editor Area -->
        <div id="editor-area">
            <div id="tabs-container">
                <!-- Tabs -->
            </div>
            
            <div id="code-wrapper">
                <div id="gutter"></div>
                <!-- Render Layer -->
                <div id="code-render" class="editor-layer"></div>
                <!-- Input Layer -->
                <textarea id="code-input" class="editor-layer" spellcheck="false" wrap="off"></textarea>
                
                <!-- Minimap -->
                <div id="minimap">
                    <canvas id="minimap-canvas"></canvas>
                    <div id="minimap-slider"></div>
                </div>
            </div>
        </div>

    </div>

    <!-- 3. Status Bar -->
    <footer id="status-bar">
        <div style="display:flex; gap:10px;">
            <div class="status-item" style="margin-left:0; background:#007acc; padding:0 10px; height:22px;"><i data-lucide="remote" width="14"></i></div>
            <div class="status-item"><i data-lucide="git-branch" width="12"></i> main</div>
            <div class="status-item"><i data-lucide="alert-circle" width="12"></i> 0 <i data-lucide="alert-triangle" width="12"></i> 0</div>
        </div>
        <div style="display:flex;">
            <div class="status-item" id="status-cursor">Ln 1, Col 1</div>
            <div class="status-item">UTF-8</div>
            <div class="status-item">LF</div>
            <div class="status-item" id="status-lang">Plain Text</div>
            <div class="status-item"><i data-lucide="bell" width="12"></i></div>
        </div>
    </footer>

    <!-- Hidden Input for Upload -->
    <input type="file" id="file-upload-input" multiple webkitdirectory />

    <!-- Context Menus -->
    <div id="ctx-explorer" class="context-menu">
        <div class="context-item" onclick="app.ctx.action('newFile')">New File</div>
        <div class="context-item" onclick="app.ctx.action('newFolder')">New Folder</div>
        <div class="context-separator"></div>
        <div class="context-item" onclick="app.ctx.action('download')">Download</div>
        <div class="context-item" onclick="app.ctx.action('rename')">Rename</div>
        <div class="context-item" onclick="app.ctx.action('delete')" style="color:#f48771">Delete</div>
    </div>

    <!-- Modals -->
    <div id="modal-overlay">
        <div class="modal-box">
            <div class="modal-header" id="modal-title">Title</div>
            <input type="text" class="modal-input" id="modal-input">
            <div style="text-align: right;">
                <button class="btn" id="modal-ok">OK</button>
                <button class="btn btn-secondary" onclick="document.getElementById('modal-overlay').style.display='none'">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        /**
         * ============================================================================
         * MODULE 1: LANGUAGE DEFINITIONS & TOKENIZER
         * ============================================================================
         */
        const LangDefs = {
            c: {
                keywords: 'auto break case char const continue default do double else enum extern float for goto if int long register return short signed sizeof static struct switch typedef union unsigned void volatile while',
                types: 'int float double char void long short',
            },
            cpp: {
                keywords: 'asm auto bool break case catch char class const const_cast continue default delete do double dynamic_cast else enum explicit export extern false float for friend goto if inline int long mutable namespace new operator private protected public register reinterpret_cast return short signed sizeof static static_cast struct switch template this throw true try typedef typeid typename union unsigned using virtual void volatile wchar_t while',
                types: 'std vector string map set',
            },
            csharp: {
                keywords: 'abstract as base bool break byte case catch char checked class const continue decimal default delegate do double else enum event explicit extern false finally fixed float for foreach goto if implicit in int interface internal is lock long namespace new null object operator out override params private protected public readonly ref return sbyte sealed short sizeof stackalloc static string struct switch this throw true try typeof uint ulong unchecked unsafe ushort using virtual void volatile while',
            },
            php: {
                keywords: 'abstract and array as break callable case catch class clone const continue declare default die do echo else elseif empty enddeclare endfor endforeach endif endswitch endwhile eval exit extends final finally for foreach function global goto if implements include include_once instanceof insteadof interface isset list namespace new or print private protected public require require_once return static switch throw trait try unset use var while xor yield',
                vars: true
            },
            python: {
                keywords: 'and as assert break class continue def del elif else except exec finally for from global if import in is lambda not or pass print raise return try while with yield',
                special: ['self', 'True', 'False', 'None']
            },
            js: {
                keywords: 'async await break case catch class const continue debugger default delete do else export extends false finally for function if import in instanceof new null return super switch this throw true try typeof var void while with let yield',
                builtins: 'console window document'
            }
        };

        class Tokenizer {
            constructor() {
                // Pre-compile regexes
            }

            tokenize(text, lang) {
                if (!lang || lang === 'txt') return this.escapeHtml(text);
                
                let html = this.escapeHtml(text);
                
                // Generic String/Comment/Number Highlighting (Simplified for performance)
                // Order: Comments -> Strings -> Numbers -> Keywords -> Functions
                
                // 1. Comments
                if (['c', 'cpp', 'csharp', 'php', 'js', 'java'].includes(lang)) {
                    html = html.replace(/(\/\/.*)/g, '<span class="tok-com">$1</span>');
                    html = html.replace(/(\/\*[\s\S]*?\*\/)/g, '<span class="tok-com">$1</span>');
                } else if (lang === 'python') {
                    html = html.replace(/(#.*)/g, '<span class="tok-com">$1</span>');
                } else if (lang === 'html') {
                    html = html.replace(/(&lt;!--[\s\S]*?--&gt;)/g, '<span class="tok-com">$1</span>');
                }

                // 2. Strings
                html = html.replace(/(['"])(?:(?=(\\?))\2.)*?\1/g, '<span class="tok-str">$&</span>');

                // 3. Keywords based on lang
                if (LangDefs[lang]) {
                    const kws = LangDefs[lang].keywords.split(' ').join('|');
                    const regex = new RegExp(`\\b(${kws})\\b`, 'g');
                    html = html.replace(regex, '<span class="tok-kw">$1</span>');
                    
                    if (LangDefs[lang].vars) {
                        html = html.replace(/(\$[a-zA-Z_]\w*)/g, '<span class="tok-var">$1</span>');
                    }
                }

                // 4. HTML/XML specific
                if (lang === 'html' || lang === 'xml') {
                    html = html.replace(/(&lt;\/?)(\w+)(.*?)(&gt;)/g, '$1<span class="tok-tag">$2</span>$3$4');
                    html = html.replace(/\b([a-zA-Z-]+)(=)/g, '<span class="tok-attr">$1</span>$2');
                }

                // 5. CSS specific
                if (lang === 'css') {
                    html = html.replace(/([\.#][\w-]+)/g, '<span class="tok-func">$1</span>'); // Selectors
                    html = html.replace(/([\w-]+)(:)/g, '<span class="tok-attr">$1</span>$2'); // Properties
                    html = html.replace(/(\d+(px|em|%|rem))/g, '<span class="tok-num">$1</span>');
                }

                // 6. Generic Numbers
                html = html.replace(/\b(\d+)\b/g, '<span class="tok-num">$1</span>');

                return html;
            }

            escapeHtml(str) {
                return str.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
            }
        }

        /**
         * ============================================================================
         * MODULE 2: FILE SYSTEM (VFS) with Upload/Download
         * ============================================================================
         */
        class FileSystem {
            constructor() {
                // Init with persistent store or default
                const saved = localStorage.getItem('vscode_vfs');
                this.tree = saved ? JSON.parse(saved) : {
                    id: 'root', name: 'Project', type: 'folder', children: [
                        { id: 'f1', name: 'main.cpp', type: 'file', content: '#include <iostream>\n\nint main() {\n    std::cout << "Hello World!";\n    return 0;\n}' },
                        { id: 'f2', name: 'script.js', type: 'file', content: 'console.log("Loaded");' },
                        { id: 'f3', name: 'style.css', type: 'file', content: 'body { background: #333; }' },
                        { id: 'f4', name: 'settings.json', type: 'file', content: '{\n    "fontSize": 14,\n    "minimap": true,\n    "theme": "dark"\n}' }
                    ]
                };
            }

            save() {
                localStorage.setItem('vscode_vfs', JSON.stringify(this.tree));
                app.ui.renderExplorer();
            }

            findNode(id, node = this.tree) {
                if (node.id === id) return node;
                if (node.children) {
                    for (let child of node.children) {
                        const found = this.findNode(id, child);
                        if (found) return found;
                    }
                }
                return null;
            }

            findParent(id, node = this.tree) {
                if (node.children) {
                    for (let child of node.children) {
                        if (child.id === id) return node;
                        const found = this.findParent(id, child);
                        if (found) return found;
                    }
                }
                return null;
            }

            createFile(parentId = 'root') {
                app.ui.prompt('New File Name:', (name) => {
                    if (!name) return;
                    const parent = parentId === 'root' ? this.tree : this.findNode(parentId);
                    const newFile = { id: Date.now().toString(), name, type: 'file', content: '' };
                    parent.children.push(newFile);
                    this.save();
                    app.editor.open(newFile.id);
                });
            }

            createFolder(parentId = 'root') {
                app.ui.prompt('New Folder Name:', (name) => {
                    if (!name) return;
                    const parent = parentId === 'root' ? this.tree : this.findNode(parentId);
                    parent.children.push({ id: Date.now().toString(), name, type: 'folder', children: [] });
                    this.save();
                });
            }

            deleteNode(id) {
                const parent = this.findParent(id);
                if (parent) {
                    parent.children = parent.children.filter(n => n.id !== id);
                    this.save();
                    app.editor.close(id);
                }
            }

            renameNode(id) {
                const node = this.findNode(id);
                if (node) {
                    app.ui.prompt('Rename to:', (name) => {
                        if (name) {
                            node.name = name;
                            this.save();
                        }
                    }, node.name);
                }
            }

            updateContent(id, content) {
                const node = this.findNode(id);
                if (node) {
                    node.content = content;
                    this.save();
                    // Check if settings.json
                    if (node.name === 'settings.json') app.settings.apply(content);
                }
            }

            // Download Handling
            download(id) {
                const node = this.findNode(id);
                if (!node) return;

                if (node.type === 'file') {
                    this.triggerDownload(node.name, node.content);
                } else {
                    alert("Folder download not implemented in this demo (requires zip lib).");
                }
            }

            triggerDownload(filename, content) {
                const element = document.createElement('a');
                element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(content));
                element.setAttribute('download', filename);
                element.style.display = 'none';
                document.body.appendChild(element);
                element.click();
                document.body.removeChild(element);
            }

            // Upload Handling
            handleUpload(files) {
                // Simplified: Put everything in root or currently selected folder
                const target = this.tree; // Default to root for demo
                
                Array.from(files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        // Check if exists
                        const existing = target.children.find(c => c.name === file.name);
                        if(!existing) {
                            target.children.push({
                                id: Date.now().toString() + Math.random(),
                                name: file.name,
                                type: 'file',
                                content: e.target.result
                            });
                        }
                        this.save();
                    };
                    reader.readAsText(file);
                });
            }
        }

        /**
         * ============================================================================
         * MODULE 3: EDITOR ENGINE
         * ============================================================================
         */
        class Editor {
            constructor() {
                this.el = document.getElementById('code-input');
                this.renderEl = document.getElementById('code-render');
                this.gutterEl = document.getElementById('gutter');
                this.activeId = null;
                this.openFiles = [];
                this.tokenizer = new Tokenizer();
                this.minimap = new Minimap();

                this.el.addEventListener('input', () => this.update());
                this.el.addEventListener('scroll', () => this.syncScroll());
                this.el.addEventListener('keydown', (e) => this.handleKey(e));
            }

            open(id) {
                const node = app.vfs.findNode(id);
                if (!node || node.type !== 'file') return;

                if (!this.openFiles.includes(id)) {
                    this.openFiles.push(id);
                }
                this.activeId = id;
                this.el.value = node.content;
                
                app.ui.renderTabs();
                this.update();
                
                // Set language in status bar
                const ext = node.name.split('.').pop();
                document.getElementById('status-lang').textContent = ext.toUpperCase();
            }

            close(id) {
                this.openFiles = this.openFiles.filter(fid => fid !== id);
                if (this.activeId === id) {
                    this.activeId = this.openFiles.length > 0 ? this.openFiles[0] : null;
                    if (this.activeId) {
                        this.open(this.activeId);
                    } else {
                        this.el.value = '';
                        this.renderEl.innerHTML = '';
                        this.gutterEl.innerHTML = '';
                    }
                }
                app.ui.renderTabs();
            }

            update() {
                if (!this.activeId) return;
                
                const code = this.el.value;
                const node = app.vfs.findNode(this.activeId);
                const lang = node.name.split('.').pop();

                // 1. Update Render Layer (Syntax Highlight)
                this.renderEl.innerHTML = this.tokenizer.tokenize(code, lang) + '<br>'; // Extra line for scroll

                // 2. Update Gutter
                const lineCount = code.split('\n').length;
                this.gutterEl.innerHTML = Array(lineCount).fill(0).map((_, i) => `<div>${i+1}</div>`).join('');

                // 3. Save
                app.vfs.updateContent(this.activeId, code);

                // 4. Update Minimap
                this.minimap.update(code);
                
                // 5. Update Status
                this.updateCursorStatus();
            }

            syncScroll() {
                this.renderEl.scrollTop = this.el.scrollTop;
                this.renderEl.scrollLeft = this.el.scrollLeft;
                this.gutterEl.scrollTop = this.el.scrollTop;
                this.minimap.scroll(this.el.scrollTop / this.el.scrollHeight);
            }

            handleKey(e) {
                if (e.key === 'Tab') {
                    e.preventDefault();
                    document.execCommand('insertText', false, '    ');
                }
                this.updateCursorStatus();
            }

            updateCursorStatus() {
                const pos = this.el.selectionStart;
                const text = this.el.value.substring(0, pos);
                const lines = text.split('\n');
                const line = lines.length;
                const col = lines[lines.length-1].length + 1;
                document.getElementById('status-cursor').textContent = `Ln ${line}, Col ${col}`;
            }
        }

        /**
         * ============================================================================
         * MODULE 4: MINIMAP RENDERER
         * ============================================================================
         */
        class Minimap {
            constructor() {
                this.canvas = document.getElementById('minimap-canvas');
                this.ctx = this.canvas.getContext('2d');
                this.slider = document.getElementById('minimap-slider');
                this.resize();
                window.addEventListener('resize', () => this.resize());
            }

            resize() {
                this.canvas.width = 100;
                this.canvas.height = document.getElementById('code-wrapper').clientHeight;
            }

            update(code) {
                const lines = code.split('\n');
                const ctx = this.ctx;
                const w = this.canvas.width;
                const h = this.canvas.height;
                
                ctx.clearRect(0, 0, w, h);
                
                // Determine scale (fit whole file if possible, or scroll)
                // Simplified: Draw pixels representing code structure
                const lineHeight = 2; // tiny lines
                const charWidth = 1.5;
                
                ctx.fillStyle = '#888';
                
                lines.forEach((line, i) => {
                    if (i * 3 > h) return; // Clip if too long for simple demo
                    
                    let x = 0;
                    // Mock tokenization for minimap colors
                    for (let j=0; j<line.length; j++) {
                        if (line[j] !== ' ') {
                            ctx.fillRect(x, i * 3, charWidth, lineHeight);
                        }
                        x += charWidth;
                    }
                });
            }

            scroll(pct) {
                const h = this.canvas.height;
                const sliderH = h * 0.1; // 10% viewport height
                this.slider.style.height = sliderH + 'px';
                this.slider.style.top = (pct * (h - sliderH)) + 'px';
            }
        }

        /**
         * ============================================================================
         * MODULE 5: UI & SETTINGS
         * ============================================================================
         */
        class SettingsManager {
            constructor() {
                // Apply defaults
                this.apply(JSON.stringify({ fontSize: 14, minimap: true }));
            }

            apply(jsonStr) {
                try {
                    const settings = JSON.parse(jsonStr);
                    const root = document.documentElement;
                    
                    if (settings.fontSize) {
                        root.style.setProperty('--font-code', `'Consolas', monospace`);
                        document.querySelectorAll('.editor-layer').forEach(el => el.style.fontSize = settings.fontSize + 'px');
                        document.getElementById('gutter').style.fontSize = settings.fontSize + 'px';
                    }
                    
                    const minimapEl = document.getElementById('minimap');
                    if (settings.minimap === false) {
                        minimapEl.style.display = 'none';
                        document.querySelectorAll('.editor-layer').forEach(el => el.style.right = '0');
                    } else {
                        minimapEl.style.display = 'block';
                        document.querySelectorAll('.editor-layer').forEach(el => el.style.right = '100px');
                    }

                } catch (e) { console.error("Invalid Settings JSON"); }
            }

            open() {
                // Check if settings file exists
                let node = app.vfs.findNode('settings.json'); // simplistic find
                if (!node) {
                    // Search in root
                    node = app.vfs.tree.children.find(c => c.name === 'settings.json');
                }
                
                if (node) {
                    app.editor.open(node.id);
                } else {
                    alert("settings.json not found in root.");
                }
            }
        }

        class UIManager {
            constructor() {
                this.explorer = document.getElementById('explorer-tree');
                this.tabs = document.getElementById('tabs-container');
            }

            renderExplorer() {
                this.explorer.innerHTML = this.buildTree(app.vfs.tree.children);
                lucide.createIcons();
            }

            buildTree(nodes, indent = 0) {
                return nodes.map(node => {
                    const pad = indent * 10;
                    if (node.type === 'folder') {
                        return `
                            <div class="tree-node" oncontextmenu="app.ctx.show(event, '${node.id}')">
                                <div class="tree-indent" style="width:${pad}px"></div>
                                <div class="node-arrow"><i data-lucide="chevron-right" width="12"></i></div>
                                <div class="node-icon"><i data-lucide="folder" width="14" color="#dcb67a"></i></div>
                                <span>${node.name}</span>
                            </div>
                            <div class="tree-children">${this.buildTree(node.children, indent + 1)}</div>
                        `;
                    } else {
                        const icon = this.getFileIcon(node.name);
                        return `
                            <div class="tree-node" onclick="app.editor.open('${node.id}')" oncontextmenu="app.ctx.show(event, '${node.id}')">
                                <div class="tree-indent" style="width:${pad}px"></div>
                                <div class="node-arrow"></div>
                                <div class="node-icon">${icon}</div>
                                <span>${node.name}</span>
                            </div>
                        `;
                    }
                }).join('');
            }

            getFileIcon(name) {
                const ext = name.split('.').pop();
                let color = '#ccc';
                let icon = 'file';
                
                switch(ext) {
                    case 'html': color = '#e34c26'; icon='file-code'; break;
                    case 'css': color = '#563d7c'; icon='palette'; break;
                    case 'js': color = '#f1e05a'; icon='file-json'; break;
                    case 'cpp': case 'c': case 'h': color = '#519aba'; icon='file-cog'; break;
                    case 'py': color = '#3572A5'; icon='file-terminal'; break;
                    case 'php': color = '#4F5D95'; icon='server'; break;
                    case 'json': color = '#F1E05A'; icon='braces'; break;
                }
                return `<i data-lucide="${icon}" width="14" color="${color}"></i>`;
            }

            renderTabs() {
                this.tabs.innerHTML = app.editor.openFiles.map(id => {
                    const node = app.vfs.findNode(id);
                    if (!node) return '';
                    const active = id === app.editor.activeId ? 'active' : '';
                    return `
                        <div class="tab ${active}" onclick="app.editor.open('${id}')" oncontextmenu="app.ctx.show(event, '${id}')">
                            ${this.getFileIcon(node.name)}
                            <span style="margin-left:5px">${node.name}</span>
                            <span class="tab-close" onclick="event.stopPropagation(); app.editor.close('${id}')">✕</span>
                        </div>
                    `;
                }).join('');
                lucide.createIcons();
            }

            prompt(msg, callback, defaultVal = '') {
                const modal = document.getElementById('modal-overlay');
                const title = document.getElementById('modal-title');
                const input = document.getElementById('modal-input');
                const btn = document.getElementById('modal-ok');

                title.textContent = msg;
                input.value = defaultVal;
                modal.style.display = 'flex';
                input.focus();

                btn.onclick = () => {
                    modal.style.display = 'none';
                    callback(input.value);
                };
            }
        }

        class ContextMenu {
            constructor() {
                this.el = document.getElementById('ctx-explorer');
                this.targetId = null;
                document.addEventListener('click', () => this.hide());
            }

            show(e, id) {
                e.preventDefault();
                this.targetId = id;
                this.el.style.left = e.clientX + 'px';
                this.el.style.top = e.clientY + 'px';
                this.el.style.display = 'block';
            }

            hide() {
                this.el.style.display = 'none';
            }

            action(act) {
                if (!this.targetId) return;
                
                switch(act) {
                    case 'newFile': app.vfs.createFile(this.targetId); break;
                    case 'newFolder': app.vfs.createFolder(this.targetId); break;
                    case 'delete': app.vfs.deleteNode(this.targetId); break;
                    case 'rename': app.vfs.renameNode(this.targetId); break;
                    case 'download': app.vfs.download(this.targetId); break;
                }
                this.hide();
            }
        }

        /**
         * ============================================================================
         * MAIN APP
         * ============================================================================
         */
        const app = {
            vfs: new FileSystem(),
            editor: new Editor(),
            ui: new UIManager(),
            settings: new SettingsManager(),
            ctx: new ContextMenu(),
            
            actions: {
                triggerUpload: () => document.getElementById('file-upload-input').click()
            }
        };

        // Init
        app.ui.renderExplorer();
        app.editor.open('f1'); // Open main.cpp

        // Bind Upload
        document.getElementById('file-upload-input').addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                app.vfs.handleUpload(e.target.files);
            }
        });

    </script>
</body>
</html>